---
title: "Exploratory Analysis"
author: "Kyle Dixon, Mia Li, Caitlin Hennessey"
date: "9/4/2020"
output: html_document
---

## Project Topic:
## Analyzing the impact of news and social media sentiment on stock prices.

### 1 - General review of raw data
#### 1.1 Load and clean data
```{r initialize, include = F}
## Load libraries
library(bit64) # To read raw data
library(caret)
library(corrplot)
library(data.table) # Faster CSV reader than base
library(doParallel)
library(dplyr)
library(e1071)
library(ggplot2) # General plotting
library(GuardianR) # Guardian API scrape
library(newsanchor) # News API scrape
library(parallel)
library(readxl)
library(rtweet) # Twitter scrape
library(rvest)
library(stringr) # Goggle news scrape
library(tau)
library(textdata)
library(plot3D)   #PCs plot
#library(RcppRoll) #CMF
library(TTR)      #Calculate Indicators: EMA,SMA,RSI
library(leaps)    #Stepwise Model Selection
library(zoo)      # Interpolation
library(elasticnet) #ridge, lasso, elastic net regression
library(earth)    #MARS, multivariate adaptive regression splines
library(vip)      #Variable importance, lecture 27
library(glmnet)   #Elastic net regression
#library(keras)    #Neural Networks
#library(tensorflow)
library(foreach)
library(kknn) #knn regression
library(pROC) #ROC curve
library(rpart) #tree
library(microbenchmark) #randomforest
library(xgboost) #boosting
library(ranger)
library(kernlab)

knitr::opts_chunk$set(echo = T)
```

```{r clean_data}
## Load raw data into the global environment
tsla <- base::data.frame(data.table::fread("1 - Data/Tesla/tsla.csv", na.strings = c("#N/A N/A", "#N/A Invalid Field", "#N/A Requesting Data...")), stringsAsFactors = F)
goog <- base::data.frame(data.table::fread("1 - Data/Google/goog.csv", na.strings = c("#N/A N/A", "#N/A Invalid Field", "#N/A Requesting Data...")), stringsAsFactors = F)

## Clean raw data
tsla <- tsla %>% dplyr::select_if(~sum(!is.na(.)) > 0) %>% # Drop columns that contain only NAs
  dplyr::filter(!is.na(PX_LAST)) # Drop rows where PX_LAST is NA
goog <- goog %>% dplyr::select_if(~sum(!is.na(.)) > 0) %>% # Drop columns that contain only NAs
  dplyr::filter(!is.na(PX_LAST)) # Drop rows where PX_LAST is NA

## Format date columns
tsla$Date <- as.Date(tsla$Date, "%m/%d/%Y")
goog$Date <- as.Date(goog$Date, "%m/%d/%Y")
```

#### 1.2 Visualize data

```{r plot_data}
## Plot prices versus time
tsla_plot <- ggplot2::ggplot() +
  ggplot2::geom_line(data = tsla, ggplot2::aes(x = Date, y = PX_LAST)) + ggplot2::ggtitle("TSLA")
goog_plot <- ggplot2::ggplot() +
  ggplot2::geom_line(data = goog, ggplot2::aes(x = Date, y = PX_LAST)) + ggplot2::ggtitle("GOOG") +
  ggplot2::scale_x_date(limits = c(base::min(tsla$Date), base::max(tsla$Date))) # Align the x-axis with TSLA
gridExtra::grid.arrange(tsla_plot, goog_plot)
```

### 2 - Data Preprocessing (Missingness and Collinearity)
#### 2.1 Data Interpolation

As we have both daily and quarterly updated features aligned in the original data set, quarterly updated features contains mainly missing values. Instead of deleting those features, missing values are interpolated between quarters.   

``` {r interpolation}
## TSLA
## Run linear interpolations
tmp <- zoo::na.approx(tsla[, base::c(14:22, 24:26)])

## Create empty matrix as placeholder for non-interpolated rows
row_diff <- base::nrow(tsla) - base::nrow(tmp)
empty <- base::matrix(base::rep(NA, row_diff * base::ncol(tmp)), nrow = row_diff, ncol = base::ncol(tmp))
base::colnames(empty) <- base::colnames(tmp)  
tmp <- base::rbind(tmp, empty)

## Replace original data with interpolation
tsla[, base::c(14:22, 24:26)] <- tmp

## GOOG
## Run linear interpolations
tmp <- zoo::na.approx(goog[, 11:23])

## Create empty matrix as placeholder for non-interpolated rows
row_diff <- base::nrow(goog) - base::nrow(tmp)
empty <- base::matrix(base::rep(NA, row_diff * base::ncol(tmp)), nrow = row_diff, ncol = base::ncol(tmp))
base::colnames(empty) <- base::colnames(tmp)  
tmp <- base::rbind(tmp, empty)

## Replace original data with interpolation
goog[, 11:23] <- tmp
```

#### 2.2 Count the number of Missing Values in each feature

```{r numNA, warning=FALSE}
require(dplyr)
totalRowTsla = base::nrow(tsla)
totalColTsla = base::ncol(tsla)

naTsla       = tsla %>%
               base::sapply(.,function(y) base::sum(base::length(base::which(base::is.na(y))))) %>%
               base::as.data.frame() %>%
               tibble::rownames_to_column(., "Features")


totalRowGoog = base::nrow(goog)
totalColGoog = base::ncol(goog)

naGoog       = goog %>%
               base::sapply(.,function(y) base::sum(base::length(base::which(base::is.na(y))))) %>%
               base::as.data.frame() %>%
               tibble::rownames_to_column(., "Features")
```

>__Tesla__

Total number of rows: `r totalRowTsla`

Total number of columns: `r totalColTsla`


```{r naTslaKnit, echo=FALSE}
knitr::kable(
 naTsla,
 col.names = c("Features","Number of Missing Values"),
 caption   = "Table 2-1: The number of Missing Values - Tesla",
 align     = "lccrr"
)
```

>__Google__

Total number of rows: `r totalRowGoog`

Total number of columns: `r totalColGoog`


```{r naGoogKnit, echo=FALSE}
knitr::kable(
 naGoog,
 col.names = c("Features","Number of Missing Values"),
 caption   = "Table 2-2: The number of Missing Values - Google",
 align     = "lccrr"
)
```


#### 2.3 Data Transformation

##### 2.3.1 Data Filtering - Tesla
Features with less than 100 missing values will be included by deleting corresponding rows with missing values instead.
```{r filterTsla, warning=FALSE}
#Select a subset of original data for data transformation and PCA
tslaSelected = tsla %>%
  .[,(which(naTsla[,2] < 100))] %>%
  .[!(apply(.,1, function(y){any(is.na(y))})),] 

#Apply Log-transformation on tslaSelected$TURNOVER to avoid producing NaN in skewness computation
tslaSelected$TURNOVER = log(tslaSelected$TURNOVER)
base::names(tslaSelected) [7]= "log(TURNOVER)"
```

##### 2.3.2 Calculate Skewness and Kurtosis - Tesla
```{r skewnessTsla, warning=FALSE}
require(e1071)
skewnessTsla = apply(tslaSelected,2,e1071::skewness)
kurtosisTsla   = apply(tslaSelected,2,e1071::kurtosis)
```

```{r skewnessTslaTable, warning=FALSE, echo=FALSE}
skewnessTsla = skewnessTsla %>%
               as.data.frame() %>%
               tibble::rownames_to_column(., "features")

knitr::kable(
 skewnessTsla,
 col.names = c("Features","Skewness"),
 caption   = "Table 2-3: Skewness of Selected Features - Tesla",
 align     = "lccrr"
)

kurtosisTsla = kurtosisTsla %>%
               as.data.frame() %>%
               tibble::rownames_to_column(., "features")

knitr::kable(
 kurtosisTsla,
 col.names = c("Features","Kurtosis"),
 caption   = "Table 2-4: Kurtosis of Selected Features - Tesla",
 align     = "lccrr"
)
```

##### 2.3.3 Data Transformation - Tesla
```{r dataTransTsla, warning=FALSE}
#Transform the selected data
(tslaTrans = caret::preProcess(tslaSelected, method = c("BoxCox","center","scale","pca")))

#Apply the transformations("BoxCox","center","scale","pca")
tslaPCA = stats::predict(tslaTrans,tslaSelected) #Outputs are PCA components
utils::head(tslaPCA)

#Summary of PCA results
tslaTrans_     = caret::preProcess(tslaSelected, method = c("BoxCox","center","scale"))
propVarTslaPCA = tslaSelected %>%
                 stats::predict(tslaTrans_,.) %>%
                 stats::prcomp() %>%
                 summary()
propVarTslaPCA #proportion of variance explained by each PCs

#Check extreme observations via PCA

ggplot(data = tslaPCA)+
  geom_point(aes(x = PC1, y= PC2))

ggplot(data = tslaPCA)+
  geom_point(aes(x = PC3, y= PC2))

ggplot(data = tslaPCA)+
  geom_point(aes(x = PC1, y= PC3))


plot3D::scatter3D(tslaPCA$PC1, tslaPCA$PC2, tslaPCA$PC3, pch = 16,  
                  theta = 20, phi = 20, main = "PCA - Tesla", xlab = "PC1", 
                  ylab ="PC2", zlab = "PC3", bty = "g", ticktype = "detailed")

```

#### Fig. 2.1 Density Plots  - Tesla
```{r dataPlotsTsla, echo=FALSE}
transformedTsla = predict(tslaTrans_,tslaSelected)
par(mfrow=c(2,2))
for (i in 1:ncol(tslaSelected)) {
  hist(tslaSelected[,i], breaks=20, freq=FALSE,
       main = paste("Density Plot - ",names(tslaSelected)[i],                            "(Before)"),xlab = " ")
  hist(transformedTsla[,i], breaks=20, freq=FALSE,
       main = paste("Density Plot - ",names(transformedTsla)[i],
                          "(After)"),xlab = " ")
}
```

##### 2.3.4 Data Filtering - Google
Features with less than 100 missing values will be included by deleting corresponding rows with missing values instead.
```{r filterGoog, warning=FALSE}
#Select a subset of original data for data transformation and PCA
googSelected = goog %>%
  .[,(which(naGoog[,2] < 100))] %>%
  .[!(apply(.,1, function(y){any(is.na(y))})),] 

#Apply Log-transformation on googSelected$TURNOVER
googSelected$TURNOVER = base::log(googSelected$TURNOVER)
base::names(googSelected) [7]= "log(TURNOVER)"
```

##### 2.3.5 Calculate Skewness and Kurtosis - Google
```{r skewnessGoog, warning=FALSE}
#require(e1071)
skewnessGoog = apply(googSelected,2,e1071::skewness)
kurtosisGoog = apply(googSelected,2,e1071::kurtosis)
```

```{r skewnessGoogTable, warning=FALSE, echo=FALSE}
skewnessGoog = skewnessGoog%>%
               as.data.frame() %>%
               tibble::rownames_to_column(., "features")

knitr::kable(
 skewnessGoog,
 col.names = c("Features","Skewness"),
 caption   = "Table 2-5: Skewness of Selected Features - Google",
 align     = "lccrr"
)


kurtosisGoog = kurtosisGoog %>%
               as.data.frame() %>%
               tibble::rownames_to_column(., "features")

knitr::kable(
 kurtosisGoog,
 col.names = c("Features","Kurtosis"),
 caption   = "Table 2-6: Kurtosis of Selected Features - Google",
 align     = "lccrr"
)

```

##### 2.3.6 Data Transformation - Google
```{r dataTransGoog, warning=FALSE}
#Transform the selected data
(googTrans = caret::preProcess(googSelected, method = c("BoxCox","center","scale","pca")))

#Apply the transformations("BoxCox","center","scale","pca")
googPCA = stats::predict(googTrans,googSelected) #Outputs are PCA components
utils::head(googPCA)

#Summary of PCA results
(googTrans_    = caret::preProcess(googSelected, method = c("BoxCox","center","scale")))
propVarGoogPCA = googSelected %>%
                 stats::predict(googTrans_,.) %>%
                 stats::prcomp() %>%
                 summary()
propVarGoogPCA #proportion of variance explained by each PCs

#Check extreme observations via PCA
ggplot(data = googPCA)+
  geom_point(aes(x = PC1, y= PC2))

ggplot(data = googPCA)+
  geom_point(aes(x = PC3, y= PC2))

ggplot(data = googPCA)+
  geom_point(aes(x = PC1, y= PC3))

plot3D::scatter3D(googPCA$PC1, googPCA$PC2, googPCA$PC3, pch = 16,  
                  theta = 20, phi = 20, main = "PCA - Alphabet", xlab = "PC1", 
                  ylab ="PC2", zlab = "PC3", bty = "g", ticktype = "detailed")

```

#### Fig. 2.2 Density Plots  - Google
```{r dataPlotsGoog, echo=FALSE}
transGoog = predict(googTrans_,googSelected)
par(mfrow=c(2,2))
for (i in 1:ncol(googSelected)) {
  hist(googSelected[,i], breaks=20, freq=FALSE,
       main = paste("Density Plot - ",names(googSelected)[i], "(After)"),
  xlab = " ")
  hist(transGoog[,i], breaks=20, freq=FALSE,
       main = paste("Density Plot - ",names(transGoog)[i], "(Before)"),
  xlab = " ")
}
```

#### 2.4 Correlation Analysis
>__Tesla__

```{r findCorrelationTsla, warning=FALSE}
library(corrplot)
corrTsla     = stats::cor(tslaSelected)
corrplot::corrplot(corrTsla, order="hclust")
```

#### Fig. 2.3 Correlations between features - Tesla

>__Google__

```{r findCorrelationGoog, warning=FALSE}
#library(corrplot)
corrGoog     = stats::cor(googSelected)
corrplot::corrplot(corrGoog, order="hclust")
```

#### Fig. 2.4 Correlations between features - Google

### 3 - News Scraping

```{r nees_scrape}
## Guardian API key
#api_key <- "d02efa1b-b4a4-4e20-a7f5-eee62d80cbf6"

## Query Guardian for TSLA news
#tsla_news <- GuardianR::get_guardian("Tesla", section = base::c("business", "technology", 
#                                                                "money", "world"), 
#                                     from.date = "2015-10-02", to.date = "2020-09-01", api.key = api_key)
#tsla_news <- tsla_news[, 4:5] # Extract relevant columns only

## Format date column
#tsla_news$webPublicationDate <- base::as.Date(base::substr(tsla_news$webPublicationDate, 1, 10), 
#                                              "%Y-%m-%d")

## Query Guardian for GOOG news
#goog_news <- GuardianR::get_guardian("Alphabet", section = base::c("business", "technology", 
#                                                                   "money", "world"), 
#                                     from.date = "2015-10-02", to.date = "2020-09-01", api.key = api_key)
#goog_news <- goog_news[, 4:5] # Extract relevant columns only

## Format date column
#goog_news$webPublicationDate <- base::as.Date(base::substr(goog_news$webPublicationDate, 1, 10), 
#                                              "%Y-%m-%d")

## Pull in news headlines from XLSX
tsla_news <- readxl::read_excel("1 - Data/Tesla/tesla news headlines from reuter 09052019-09092020.xlsx")
goog_news <- readxl::read_excel("1 - Data/Google/alphabet inc. news headlines from reuter 07112019-10302020.xlsx")

#tsla_news <- readxl::read_excel("tesla news headlines from reuter 09052019-09092020.xlsx")
#goog_news <- readxl::read_excel("alphabet inc. news headlines from reuter 07112019-10302020.xlsx")

## Format date columns
tsla_news$date <- base::as.Date(tsla_news$date, "%B %d,%Y")
goog_news$date <- base::as.Date(goog_news$date, "%B %d, %Y")

## Rename headline columns to match previous code
base::names(tsla_news) <- c("Date", "Time", "webTitle", "Keywords")
base::names(goog_news) <- c("Date", "Time", "webTitle", "Keywords")

## Get positive and negative words from Loughran and McDonald
positive_words <- base::data.frame(
  readxl::read_excel("2 - Word Lists/LoughranMcDonald_SentimentWordLists_2018.xlsx",
                     sheet = "Positive", col_names = F))$...1

negative_words <- base::data.frame(
  readxl::read_excel("2 - Word Lists/LoughranMcDonald_SentimentWordLists_2018.xlsx",
                     sheet = "Negative", col_names = F))$...1

## Calculate sentiment for TSLA
tsla_news$Sentiment <- base::as.numeric(NA)
for (row in 1:base::nrow(tsla_news)) {
  tmp <- base::strsplit(tsla_news[row, ]$webTitle, "[[:space:]]|(?=[.!?])", perl = T)[[1]]
  
  sentiment <- 0
  for (word in tmp) {
    if (base::nchar(word) > 1 & !(base::grepl("\\(", word)) & !(base::grepl("\\)", word))) {
      if (base::any(stringr::str_detect(positive_words, stringr::regex(word, ignore_case = T)))) {
        sentiment <- sentiment + 1
      } else if (base::any(stringr::str_detect(negative_words, stringr::regex(word, ignore_case = T)))) {
        sentiment <- sentiment - 1
      }
    }
  }
  tsla_news[row, ]$Sentiment <- sentiment
}

## Calculate sentiment for GOOG
goog_news$Sentiment <- base::as.numeric(NA)
for (row in 1:base::nrow(goog_news)) {
  tmp <- base::strsplit(goog_news[row, ]$webTitle, "[[:space:]]|(?=[.!?])", perl = T)[[1]]
  
  sentiment <- 0
  for (word in tmp) {
    if (base::nchar(word) > 1 & !(base::grepl("\\(", word)) & !(base::grepl("\\)", word))) {
      if (base::any(stringr::str_detect(positive_words, stringr::regex(word, ignore_case = T)))) {
        sentiment <- sentiment + 1
      } else if (base::any(stringr::str_detect(negative_words, stringr::regex(word, ignore_case = T)))) {
        sentiment <- sentiment - 1
      }
    }
  }
  goog_news[row, ]$Sentiment <- sentiment
}

goog_news$Ticker <- "GOOG"
tsla_news$Ticker <- "TSLA"
plot_data <- dplyr::bind_rows(goog_news, tsla_news)
mu <- plyr::ddply(plot_data, "Ticker", summarise, grp.mean = mean(Sentiment))
ggplot2::ggplot(data = plot_data, ggplot2::aes(x = Sentiment, fill = Ticker)) + 
  ggplot2::geom_density(alpha = 0.5, adjust = 1.5) + 
  ggplot2::geom_vline(data = mu, ggplot2::aes(xintercept = grp.mean, color = Ticker),
                      linetype = "dashed") +
  ggplot2::scale_color_manual(values = c("#5f506b", "#86bbbd")) + 
  ggplot2::scale_fill_manual(values = c("#5f506b", "#86bbbd"))
```


### 4 - Twitter Scraping

```{r twitter_scrape}
cl = makeCluster(8)
registerDoParallel(cl)
## Twitter API keys and secrets
api_key <- "zElIwld33bNohcb28j7si3aBW"
api_secret_key <- "a5yDRmHeFpq2tpqk4u687rAyDuApzUe2ZffYir3disyqa98QGb"
bearer_token <- "AAAAAAAAAAAAAAAAAAAAAH2iGAEAAAAApwFAjq60a%2Ba8gOG2URX2scAHOo0%3DPXz3xx1Z5i8YuqNzRt6wSAINxOkqNrArIESFlnxWCToPHhEcRH"
access_token <- "1271553006522306568-Azxsa0o7nHOCNpvRjRdocbWPYz0D6w"
access_token_secret <- "PwT1GB0Ogj0poevifeUShWB4lEZAODXHWfm8HyXRz2J7e"

## Create Twitter token
twitter_token <- rtweet::create_token(app = "BNC Sentiment Analysis", consumer_key = api_key, consumer_secret = api_secret_key, access_token = access_token, access_secret = access_token_secret)

## Get positive and negative words from Loughran and McDonald
positive_words <- base::data.frame(
  readxl::read_excel("2 - Word Lists/LoughranMcDonald_SentimentWordLists_2018.xlsx",
                     sheet = "Positive", col_names = F))$...1

negative_words <- base::data.frame(
  readxl::read_excel("2 - Word Lists/LoughranMcDonald_SentimentWordLists_2018.xlsx",
                     sheet = "Negative", col_names = F))

## Loop through tickers and pull tweets
sentiment <- base::data.frame("Ticker" = base::character(),
                              "Date" = base::as.Date(base::character()),
                              "Sentiment" = base::numeric(), stringsAsFactors = F)

for (index in 1:2) {
  tickers <- c("TSLA", "GOOG"); ticker <- tickers[index]
  
  ## Pull tweets (this will throw an authentication page the first time)
  search <- base::ifelse(ticker == "TSLA", "Tesla", "Google")
  tweets <- rtweet::search_tweets(q = search, n = 1000, include_rts = F,
                                  retryonratelimit = T)
  
  tweets$sentiment <- as.numeric(NA)
  for (i in 1:base::nrow(tweets)) {
    values <- base::numeric()
    for (word in base::strsplit(tweets[i, ]$text, "[[:punct:] ]")[[1]]) {
      if (word %in% positive_words) {values <- append(values, 1)}
      else if (word %in% negative_words) {values <- append(values, -1)}
      else {values <- append(values, 0)}
    }
    tweets[i, ]$sentiment <- base::sum(values)
    print(i)
  }

  ## Check sentiment
  tweets$sentiment <- base::round(stats::weighted.mean(tweets$sentiment,
                                                 w = tweets$favorite_count + tweets$favorite_count),
                            digits = 1)
  tweets$created_at <- base::as.Date(tweets$created_at, "%Y-%m-%d")
  tmp <- tweets %>% dplyr::group_by(created_at) %>% dplyr::summarize("sentiment" = base::sum(sentiment))
  sentiment <- base::append(sentiment, tmp)
}

names(sentiment) <- c("TSLA", "GOOG")

ggplot2::ggplot(sentiment, ggplot2::aes(x = Date, y = Sentiment, color = Ticker)) + ggplot2::geom_line() + ggplot2::ggtitle("Twitter Sentiment Over Time")



```



```{r newVar}
###TSLA
tslaTemp = tslaSelected %>% 
  dplyr::mutate(
         PP = lag((PX_HIGH + PX_LOW + PX_LAST)/3), #Previous Day (High + Low + Close) / 3
         R1 = 2 * PP - lag(PX_LOW),                #(Pivot x 2) – Previous Day Low
         S1 = 2 * PP - lag(PX_HIGH),               #(Pivot x 2) – Previous Day High
         R2 = PP + (R1 - S1),                      #Pivot + (R1 – S1)
         S2 = PP - (R1 - S1),                      #Pivot - (R1 – S1)
         R3 = lag(PX_HIGH) + 2 * (PP - lag(PX_LOW)),    
         #R3= Previous Day High + 2(PP – Previous Day Low)
         S3 = lag(PX_LOW) - 2 * (lag(PX_HIGH) - PP),
         #S3= Previous Day Low – 2(Previous Day High – Pivot)
         diffHighLow  = PX_HIGH - PX_LOW,
         diffLastOpen = PX_LAST - PX_OPEN,
         stockReturn  = (PX_LAST - PX_OPEN)/PX_OPEN
         )

highCorrF = function(dta, thred){
  #Find highly correlated features
  highCorr = dta %>%
  cor %>%
  caret::findCorrelation(thred, names = TRUE)
  return(highCorr)
}


hclustPlotF = function(dta) {
  #Correlation Plot
  corrplot::corrplot(cor(dta), order="hclust")
}

###GOOG
googTemp = googSelected %>% 
  dplyr::mutate(
         PP = lag((PX_HIGH + PX_LOW + PX_LAST)/3), #Previous Day (High + Low + Close) / 3
         R1 = 2 * PP - lag(PX_LOW),                #(Pivot x 2) – Previous Day Low
         S1 = 2 * PP - lag(PX_HIGH),               #(Pivot x 2) – Previous Day High
         R2 = PP + (R1 - S1),                      #Pivot + (R1 – S1)
         S2 = PP - (R1 - S1),                      #Pivot - (R1 – S1)
         R3 = lag(PX_HIGH) + 2 * (PP - lag(PX_LOW)),    
         #R3= Previous Day High + 2(PP – Previous Day Low)
         S3 = lag(PX_LOW) - 2 * (lag(PX_HIGH) - PP),
         #S3= Previous Day Low – 2(Previous Day High – Pivot)
         diffHighLow  = PX_HIGH - PX_LOW,
         diffLastOpen = PX_LAST - PX_OPEN,
         stockReturn  = (PX_LAST - PX_OPEN)/PX_OPEN
         )
```


```{r OnBalanceVolume}
###TSLA

tslaAddOBV = tslaTemp %>% 
  mutate(obv = TTR::OBV(PX_LAST, PX_VOLUME))

###GOOG
googAddOBV = googTemp %>% 
  mutate(obv = TTR::OBV(PX_LAST, PX_VOLUME))

```



```{r chaikinMoneyFlow}
#TSLA
daysCMF = 21
tslaAddCMF = tslaAddOBV %>%
  mutate(cmf = TTR::CMF(tslaAddOBV[,c("PX_HIGH","PX_LOW","PX_LAST")], PX_VOLUME, n = daysCMF))
#GOOG
daysCMF = 21
googAddCMF = googAddOBV %>%
  mutate(cmf = TTR::CMF(googAddOBV[,c("PX_HIGH","PX_LOW","PX_LAST")], PX_VOLUME, n = daysCMF))
```



```{r exponentialMovingAverage}
#TSLA
daysEMA = 10 #EMA lengths
tslaAddEMA = tslaAddCMF %>%
  mutate(emaPrice = TTR::EMA(tslaAddCMF$PX_LAST,daysEMA)) %>%
  mutate(emaVolume = TTR::EMA(tslaAddCMF$PX_VOLUME,daysEMA))

###GOOG
daysEMA = 10 #EMA lengths
googAddEMA = googAddCMF %>%
  mutate(emaPrice = TTR::EMA(googAddCMF$PX_LAST,daysEMA)) %>%
  mutate(emaVolume = TTR::EMA(googAddCMF$PX_VOLUME,daysEMA))
```

```{r relativeStrengthIndex(RSI)}
###Tsla
daysRSI = 14
tslaAddRSI = tslaAddEMA %>%
  mutate(rsi = TTR::RSI(PX_LAST, n=daysRSI, maType="WMA", wts=PX_VOLUME))
###GOOG
daysRSI = 14
googAddRSI = googAddEMA %>%
  mutate(rsi = TTR::RSI(PX_LAST, n=daysRSI, maType="WMA", wts=PX_VOLUME))
```


```{r simpleMovingAverage(SMA)}
###Tsla
daysSMA = 10
tslaAddSMA = tslaAddRSI %>%
  mutate(smaPrice = TTR::SMA(PX_LAST, n=daysSMA)) %>%
  mutate(smaVolume = TTR::SMA(PX_VOLUME, n=daysSMA))
###GOOG
daysSMA = 10
googAddSMA = googAddRSI %>%
  mutate(smaPrice = TTR::SMA(PX_LAST, n=daysSMA)) %>%
  mutate(smaVolume = TTR::SMA(PX_VOLUME, n=daysSMA))
```

```{r momentumStochasticIndex(K% and D%)}
###Tsla
#Stochastic Momentum Index
daysK = 5 #%K is usually set to 5 and represents the main movements of price – slow line.
daysD = 3 #%D is the fast line, a simple moving average of the %K and is set to 3.
tslaHLC  = tslaSelected %>% dplyr::select(PX_HIGH, PX_LOW, PX_LAST)
tslaAddK = tslaAddSMA %>%
 dplyr::mutate(smi_K = (stoch(tslaHLC, nFastK = daysK, nFastD = daysD, nSlowD = 3, bounded = TRUE,smooth = 1))[,1]) %>% #calculate fastK%
 dplyr::mutate(smi_D = (stoch(tslaHLC, nFastK = daysK, nFastD = daysD, nSlowD = 3, bounded = TRUE,smooth = 1))[,2])  #calculate fastD%

###GOOG
daysK = 5 #%K is usually set to 5 and represents the main movements of price – slow line.
daysD = 3 #%D is the fast line, a simple moving average of the %K and is set to 3.
googHLC  = googSelected %>% dplyr::select(PX_HIGH, PX_LOW, PX_LAST)
googAddK = googAddSMA %>%
 dplyr::mutate(smi_K = (stoch(googHLC, nFastK = daysK, nFastD = daysD, nSlowD = 3, bounded = TRUE,smooth = 1))[,1]) %>% #calculate fastK%
 dplyr::mutate(smi_D = (stoch(googHLC, nFastK = daysK, nFastD = daysD, nSlowD = 3, bounded = TRUE,smooth = 1))[,2])  #calculate fastD%
```


```{r MACD}
###TSLA
daysMACDslow   = 26 #default nSlow
daysMACDfast   = 12 #default nFast
daysMACDsignal = 9  #default nSig

tslaAddMACD = tslaAddK %>%
  mutate(macdPrice = (TTR::MACD(PX_LAST, nFast = daysMACDfast, nSlow = daysMACDslow, nSig = daysMACDsignal))[,1]) %>%
  #mutate(macdPrice = TTR::MACD(nFast = 12, nSlow = 26, nSig = 9, maType="WMA", wts=PX_VOLUME)) %>% # weighted macdPrice
  mutate(macdVolume = (TTR::MACD(PX_VOLUME, nFast = daysMACDfast, nSlow = daysMACDslow, nSig = daysMACDsignal))[,1])

###GOOG
daysMACDslow   = 26 #default nSlow
daysMACDfast   = 12 #default nFast
daysMACDsignal = 9  #default nSig

googAddMACD = googAddK %>%
  mutate(macdPrice = (TTR::MACD(PX_LAST, nFast = daysMACDfast, nSlow = daysMACDslow, nSig = daysMACDsignal))[,1]) %>%
  #mutate(macdPrice = TTR::MACD(nFast = 12, nSlow = 26, nSig = 9, maType="WMA", wts=PX_VOLUME)) %>% # weighted macdPrice
  mutate(macdVolume = (TTR::MACD(PX_VOLUME, nFast = daysMACDfast, nSlow = daysMACDslow, nSig = daysMACDsignal))[,1])
```

```{r LarryWilliam's R%}
###TSLA
daysR = 14 #default
#tslaHLC  = tslaSelected %>% dplyr::select(PX_HIGH, PX_LOW, PX_LAST)
tslaAddR = tslaAddMACD %>%
  mutate(larryWilliamsR = TTR::WPR(tslaHLC, n = daysR))

###GOOG
daysR = 14 #default
#googHLC  = googSelected %>% dplyr::select(PX_HIGH, PX_LOW, PX_LAST)
googAddR = googAddMACD %>%
  mutate(larryWilliamsR = TTR::WPR(googHLC, n = daysR))

```


```{r Accumulation/Distribution}
###TSLA
tslaAddAD = tslaAddR %>%
  mutate(williamsAD = TTR::williamsAD(tslaHLC))
###GOOG
googAddAD = googAddR %>%
  mutate(williamsAD = TTR::williamsAD(googHLC))

```



```{r CommodityChannelIndex(CCI)}
###TSLA
daysCCI = 20
tslaAddCCI = tslaAddAD %>%
  mutate(cci = TTR::CCI(tslaHLC, n = daysCCI))

###GOOG
daysCCI = 20
googAddCCI = googAddAD %>%
  mutate(cci = TTR::CCI(googHLC, n = daysCCI))

#--End--#

#Summarize how many indicators we've added. 

beforeAfterVarTsla = tslaAddCCI[,(ncol(tslaSelected)+1):ncol(tslaAddCCI)]
names(beforeAfterVarTsla)

beforeAfterVarGoog = googAddCCI[,(ncol(googSelected)+1):ncol(googAddCCI)]
names(beforeAfterVarGoog)
```

```{r additionMeasuresOnStockTrend}
###TSLA
#Calculate stock price trend supported with significant volume increase
tslaAddVolYesterday = addLaggedVarF(tslaAddCCI$PX_VOLUME,tslaAddCCI, "pastVolume", 1)
tslaAddPx_lastYesterday = addLaggedVarF(tslaAddVolYesterday$PX_LAST,tslaAddVolYesterday, "pastLastPrice", 1)

tslaAddVolTemp1 = tslaAddPx_lastYesterday %>%
  mutate(diffVolume = PX_VOLUME - pastVolume1) %>%
  dplyr::slice(-1) %>%
  mutate(increasedVolume = rep(0.01, nrow(.)))

for (i in 1:nrow(tslaAddVolTemp1)) {
  if (tslaAddVolTemp1$diffVolume[i] <=0 ) {
    tslaAddVolTemp1$increasedVolume[i] = 0
  } else {
    tslaAddVolTemp1$increasedVolume[i] = 1*tslaAddVolTemp1$diffVolume[i] 
  }
}


varPastVolumesF = function(featureVolume,lagsize) {
  pastVol_upper = rep(0.0123, length(featureVolume))
  for (d in 1:(length(featureVolume) - lagsize + 1)) {
    pastVol = featureVolume[d:(d + lagsize - 1)]
    pastVol_upper[d+lagsize - 1] = mean(pastVol) + 1.28*var(pastVol)**.5 
    #80% confidence
  }
  return(pastVol_upper)
}

pastVol_upperTsla = varPastVolumesF(tslaAddVolTemp1$PX_VOLUME,5) 
#pastVol_upper[1:20]

tslaAddVolTemp2 = tslaAddVolTemp1 %>%
  mutate(pastVol_upperTsla) %>%
  mutate(afterHourDiffPriceRatio = (PX_OPEN - pastLastPrice1)/pastLastPrice1) %>% 
  #afterHourDiffPrice = closePrice_yesterday - openPrice_today
  mutate(largerThanUpperVol = rep(0.0123, nrow(.)))

#Valid volume increase (when the current volume is larger than the upper bound of volumes in past five days including the current date.)

for (i in 1:nrow(tslaAddVolTemp2)) {
  if (tslaAddVolTemp2$PX_VOLUME[i] < tslaAddVolTemp2$pastVol_upper[i]) {
    tslaAddVolTemp2$largerThanUpperVol[i] = 0
  } else {
    tslaAddVolTemp2$largerThanUpperVol[i] = 1*tslaAddVolTemp2$diffVolume[i] 
  }
}

#names(tslaAddVolTemp2)
#Add interaction terms
tslaAddVolTrend = tslaAddVolTemp2 %>% 
  mutate(increaseTrend = diffLastOpen * increasedVolume) %>%
  mutate(strongIncreaseTrend = diffLastOpen * largerThanUpperVol) %>%
  select(- c(pastVolume1,pastLastPrice1,diffVolume,increasedVolume,pastVol_upperTsla,largerThanUpperVol))



###GOOG
#Calculate stock price trend supported with significant volume increase
googAddVolYesterday = addLaggedVarF(googAddCCI$PX_VOLUME,googAddCCI, "pastVolume", 1)
googAddPx_lastYesterday = addLaggedVarF(googAddVolYesterday$PX_LAST,googAddVolYesterday, "pastLastPrice", 1)

googAddVolTemp1 = googAddPx_lastYesterday %>%
  mutate(diffVolume = PX_VOLUME - pastVolume1) %>%
  dplyr::slice(-1) %>%
  mutate(increasedVolume = rep(0.01, nrow(.)))

for (i in 1:nrow(googAddVolTemp1)) {
  if (googAddVolTemp1$diffVolume[i] <=0 ) {
    googAddVolTemp1$increasedVolume[i] = 0
  } else {
    googAddVolTemp1$increasedVolume[i] = 1*googAddVolTemp1$diffVolume[i] 
  }
}

pastVol_upperGoog = varPastVolumesF(googAddVolTemp1$PX_VOLUME,5) 
#pastVol_upper[1:20]

googAddVolTemp2 = googAddVolTemp1 %>%
  mutate(pastVol_upperGoog) %>%
  mutate(afterHourDiffPriceRatio = (PX_OPEN - pastLastPrice1)/pastLastPrice1) %>% 
  #afterHourDiffPrice = closePrice_yesterday - openPrice_today
  mutate(largerThanUpperVol = rep(0.0123, nrow(.)))

#Valid volume increase (when the current volume is larger than the upper bound of volumes in past five days including the current date.)

for (i in 1:nrow(googAddVolTemp2)) {
  if (googAddVolTemp2$PX_VOLUME[i] < googAddVolTemp2$pastVol_upperGoog[i]) {
    googAddVolTemp2$largerThanUpperVol[i] = 0
  } else {
    googAddVolTemp2$largerThanUpperVol[i] = 1*googAddVolTemp2$diffVolume[i] 
  }
}

#names(googAddVolTemp2)
#Add interaction terms
googAddVolTrend = googAddVolTemp2 %>% 
  mutate(increaseTrend = diffLastOpen * increasedVolume) %>%
  mutate(strongIncreaseTrend = diffLastOpen * largerThanUpperVol) %>%
  select(- c(pastVolume1,pastLastPrice1,diffVolume,increasedVolume,pastVol_upperGoog,largerThanUpperVol))

```

Up till now, we added:
*TSLA stock indicators
`r names(beforeAfterVarTsla)`

*GOOG stock indicators
`r names(beforeAfterVarGoog)`

```{r addLaggedVariablesFunctions}
#Add lagged values of features. 
addLaggedVarF = function(feature, dataForModification, featureName,lagSize ) {
  for (lags in 1:lagSize) { 
    newColName = paste0(featureName, lags)
    dataForModification = dataForModification %>%
      dplyr::mutate(!!sym(newColName) := dplyr::lag(feature, n = lags))
  }
  return(dataForModification)
}


addDiffVarF = function(dataForModification,nColumn) {
  #"tslaSelected" is created to remove features with too many missing values from the original data
  #Purpose: Take the first difference of features in "tslaSelected"
  diffFeature = as_tibble(matrix(rep(0,((nrow(dataForModification)-1)*nColumn)),ncol = nColumn))
  featureName = names(dataForModification)[1:nColumn]
  
  for (j in 1:nColumn) {
    diffFeature[,j] = as_tibble(matrix(diff(dataForModification[,j]), ncol = 1))
    names(diffFeature)[j] = paste0(featureName[j],"_diffPreviousDay")
  }
 diffFeature = lag(diffFeature) #Use the difference between today and yesterday to predict tomorrow; first two rows should be NAs. It will be taken care later with na.omit()
 dataForModification_ = dataForModification[2:nrow(dataForModification),]
 laggedDiff = cbind(dataForModification_,diffFeature)
 laggedDiff %>% transmute()
 return(laggedDiff)
}

#tslaAddDiff =  addDiffVarF(tslaSelected,ncol(tslaSelected))
``` 


###Final Task

```{r dailySentiments}
tslaSentiments = tsla_news %>%
  group_by(Date) %>%
  summarise(tslaSentimentsSum = sum(Sentiment, na.rm = TRUE),
            tslaSentimentsMean = mean(Sentiment, na.rm = TRUE))

googSentiments = goog_news %>%
  group_by(Date) %>%
  summarise(googSentimentsSum = sum(Sentiment, na.rm = TRUE), 
            googSentimentsMean = mean(Sentiment, na.rm = TRUE))
```

```{r assignYandX}
tslaAddVolTrendRemoveNA = tslaAddVolTrend %>%
  na.omit(.)
tslaFullStandardized =  tslaAddVolTrendRemoveNA %>%
  caret::preProcess(method = c("center","scale")) %>%
  predict(newdata =tslaAddVolTrendRemoveNA)


###TSLA
tslaY  = tslaFullStandardized %>%
  dplyr::select(Date,diffHighLow, stockReturn) %>%
  dplyr::as_tibble() %>%
  dplyr::slice(-1) %>%
  mutate(stockReturnDummy = if_else(stockReturn >= 0, 1, 0))

tslaX    = tslaFullStandardized %>%
  .[1:(nrow(.)-1),] %>%
  dplyr::as_tibble(.) 

names(tslaY)[2] = "diffHighLowTomorrow" #Y1
names(tslaY)[3] = "stockReturnTomorrow" #Y2
names(tslaY)[4] = "stockReturnTomorrowDummy" #Y3
nrow(tslaX)
nrow(tslaY)
#####Dummy Variables
###TSLA
XtslaAddLevels = tslaX %>%
  mutate(aboveR1 = factor(ifelse(PX_HIGH > R1, "Yes", "No"))) %>%
  mutate(aboveR2 = factor(ifelse(PX_HIGH > R2, "Yes", "No"))) %>%
  mutate(aboveR3 = factor(ifelse(PX_HIGH > R3, "Yes", "No"))) %>%
  mutate(belowS1 = factor(ifelse(PX_LOW  < S1, "Yes", "No"))) %>%
  mutate(belowS2 = factor(ifelse(PX_LOW  < S2, "Yes", "No"))) %>%
  mutate(belowS3 = factor(ifelse(PX_LOW  < S3, "Yes", "No"))) %>%
  select(aboveR1, aboveR2, aboveR3, belowS1, belowS2, belowS3)            
XtslaDummyModel = caret::dummyVars(~ ., data = XtslaAddLevels, fullRank = TRUE)


YtslaAddLevels = as_tibble(factor(ifelse(tslaY$stockReturnTomorrow > 0, "Increased", "Decreased"))) 
YtslaDummyModel = caret::dummyVars(~ ., data = YtslaAddLevels, fullRank = TRUE)



XtslaDummy = as_tibble(predict(XtslaDummyModel, XtslaAddLevels))

YtslaDummy = as_tibble(predict(YtslaDummyModel, YtslaAddLevels))
names(YtslaDummy)[1] = "stockReturnTomorrowDummy" #Y2

nrow(XtslaDummy)
nrow(YtslaDummy)

#tslaFullWithDummy = tslaFullStandardized %>% 
#  mutate(XtslaDummy) %>% 
#  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3) %>% 
#  #Drop PP, R1, R2, R3, S1, S2, S3 
#  mutate(YtslaDummy) 

XtslaWithDummy = tslaX %>%
  mutate(XtslaDummy) %>% 
  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3)

XtslaWithoutDummy = tslaX %>%
  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3)

YtslaWithDummy = tslaY %>% mutate(YtslaDummy) 

#X:20190909 - 20200828
#Y:20190910 - 20200831
XtslaWithDummy_subset = XtslaWithDummy[2164:nrow(XtslaWithDummy),] 
YtslaWithDummy_subset = YtslaWithDummy[2164:nrow(YtslaWithDummy),]
YtslaWithDummy_subsetWithoutDate = YtslaWithDummy_subset[,-1]

tslaFull = cbind(YtslaWithDummy_subsetWithoutDate,XtslaWithDummy_subset) 
tslaFullWithSentiments = merge(tslaFull,tslaSentiments)

XtslaWithSentiments = tslaFullWithSentiments %>%
  select(-c(Date,diffHighLowTomorrow,stockReturnTomorrow,stockReturnTomorrowDummy))
YtslaWithSentiments = tslaFullWithSentiments %>%
  select(c(Date,diffHighLowTomorrow,stockReturnTomorrow,stockReturnTomorrowDummy))



##GOOG

googAddVolTrendRemoveNA = googAddVolTrend %>%
  na.omit(.)
googFullStandardized =  googAddVolTrendRemoveNA %>%
  caret::preProcess(method = c("center","scale")) %>%
  predict(newdata =googAddVolTrendRemoveNA)

googY  = googFullStandardized %>%
  dplyr::select(Date,diffHighLow, stockReturn) %>%
  dplyr::as_tibble() %>%
  dplyr::slice(-1) %>%
  mutate(stockReturnDummy = if_else(stockReturn >= 0, 1, 0))

googX    = googFullStandardized %>%
  .[1:(nrow(.)-1),] %>%
  dplyr::as_tibble(.) 

names(googY)[2] = "diffHighLowTomorrow" #Y1
names(googY)[3] = "stockReturnTomorrow" #Y2
names(googY)[4] = "stockReturnTomorrowDummy" #Y3

#####Dummy Variables

###GOOG
XgoogAddLevels = googX %>%
  mutate(aboveR1 = factor(ifelse(PX_HIGH > R1, "Yes", "No"))) %>%
  mutate(aboveR2 = factor(ifelse(PX_HIGH > R2, "Yes", "No"))) %>%
  mutate(aboveR3 = factor(ifelse(PX_HIGH > R3, "Yes", "No"))) %>%
  mutate(belowS1 = factor(ifelse(PX_LOW  < S1, "Yes", "No"))) %>%
  mutate(belowS2 = factor(ifelse(PX_LOW  < S2, "Yes", "No"))) %>%
  mutate(belowS3 = factor(ifelse(PX_LOW  < S3, "Yes", "No"))) %>%
  select(aboveR1, aboveR2, aboveR3, belowS1, belowS2, belowS3)            
XgoogDummyModel = caret::dummyVars(~ ., data = XgoogAddLevels, fullRank = TRUE)



YgoogAddLevels = as_tibble(factor(ifelse(googY$stockReturnTomorrow > 0, "Increased", "Decreased"))) 
YgoogDummyModel = caret::dummyVars(~ ., data = YgoogAddLevels, fullRank = TRUE)


XgoogDummy = as_tibble(predict(XgoogDummyModel, XgoogAddLevels))
YgoogDummy = as_tibble(predict(YgoogDummyModel, YgoogAddLevels))

names(YgoogDummy)[1] = "stockReturnTomorrowDummy" #Y2


XgoogWithDummy = googX %>%
  mutate(XgoogDummy) %>% 
  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3)

XgoogWithoutDummy = googX %>%
  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3)

YgoogWithDummy = googY %>% mutate(YgoogDummy) 

#X:20190711 - 20200828
#Y:20190712 - 20200831

XgoogWithDummy_subset = XgoogWithDummy[1306:nrow(XgoogWithDummy),] 
YgoogWithDummy_subset = YgoogWithDummy[1306:nrow(YgoogWithDummy),]
YgoogWithDummy_subsetWithoutDate = YgoogWithDummy_subset[,-1]

googFull = cbind(YgoogWithDummy_subsetWithoutDate,XgoogWithDummy_subset) 
googFullWithSentiments = merge(googFull,googSentiments)

XgoogWithSentiments = googFullWithSentiments %>%
  select(-c(Date,diffHighLowTomorrow,stockReturnTomorrow,stockReturnTomorrowDummy))
YgoogWithSentiments = googFullWithSentiments %>%
  select(c(Date,diffHighLowTomorrow,stockReturnTomorrow,stockReturnTomorrowDummy))
```


###### 7 - Final Task without sentiments (updated from Task 3) 

```{r dataSplitFinalTask}
#Line 990
#Superviors:
  #Y1: YtslaWithSentiments$diffHighLowTomorrow
  #Y2: YtslaWithSentiments$stockReturnTomorrow
  #Y3: YtslaWithSentiments$stockReturnTomorrowDummy

#Features wtihtout Sentiments:
XtslaWithoutSentiments = XtslaWithSentiments %>%
  select(-c(tslaSentimentsSum,tslaSentimentsMean))
XgoogWithoutSentiments = XgoogWithSentiments %>%
  select(-c(googSentimentsSum,googSentimentsMean))

#Data Split
##TSLA

set.seed(2020)
inTrain_tslaHL = caret::createDataPartition(YtslaWithSentiments$diffHighLowTomorrow, p = 4/5, list = FALSE) #Y1
inTrain_tslaSR = caret::createDataPartition(YtslaWithSentiments$stockReturnTomorrow, p = 4/5, list = FALSE) #Y2
inTrain_tslaSRdummy = caret::createDataPartition(YtslaWithSentiments$stockReturnTomorrowDummy, p = 4/5, list = FALSE) #Y3


Ytrain_tslaHL = YtslaWithSentiments$diffHighLowTomorrow[inTrain_tslaHL]
Ytest_tslaHL  = YtslaWithSentiments$diffHighLowTomorrow[-inTrain_tslaHL]
Ytrain_tslaSR = YtslaWithSentiments$stockReturnTomorrow[inTrain_tslaSR]
Ytest_tslaSR  = YtslaWithSentiments$stockReturnTomorrow[-inTrain_tslaSR]
Ytrain_tslaSRdummy = YtslaWithSentiments$stockReturnTomorrowDummy[inTrain_tslaSRdummy]
Ytest_tslaSRdummy  = YtslaWithSentiments$stockReturnTomorrowDummy[-inTrain_tslaSRdummy]


Xtrain_tslaHL = XtslaWithoutSentiments[inTrain_tslaHL,] 
Xtest_tslaHL  = XtslaWithoutSentiments[-inTrain_tslaHL,]
Xtrain_tslaSR = XtslaWithoutSentiments[inTrain_tslaSR,] 
Xtest_tslaSR  = XtslaWithoutSentiments[-inTrain_tslaSR,]
Xtrain_tslaSRdummy = XtslaWithoutSentiments[inTrain_tslaSRdummy,]
Xtest_tslaSRdummy  = XtslaWithoutSentiments[-inTrain_tslaSRdummy,]

###GOOG

set.seed(2020)
inTrain_googHL = caret::createDataPartition(YgoogWithSentiments$diffHighLowTomorrow, p = 4/5, list = FALSE) #Y1
inTrain_googSR = caret::createDataPartition(YgoogWithSentiments$stockReturnTomorrow, p = 4/5, list = FALSE) #Y2
inTrain_googSRdummy = caret::createDataPartition(YgoogWithSentiments$stockReturnTomorrowDummy, p = 4/5, list = FALSE) #Y3


Ytrain_googHL = YgoogWithSentiments$diffHighLowTomorrow[inTrain_googHL]
Ytest_googHL  = YgoogWithSentiments$diffHighLowTomorrow[-inTrain_googHL]
Ytrain_googSR = YgoogWithSentiments$stockReturnTomorrow[inTrain_googSR]
Ytest_googSR  = YgoogWithSentiments$stockReturnTomorrow[-inTrain_googSR]
Ytrain_googSRdummy = YgoogWithSentiments$stockReturnTomorrowDummy[inTrain_googSRdummy]
Ytest_googSRdummy  = YgoogWithSentiments$stockReturnTomorrowDummy[-inTrain_googSRdummy]


Xtrain_googHL = XgoogWithoutSentiments[inTrain_googHL,]
Xtest_googHL  = XgoogWithoutSentiments[-inTrain_googHL,]
Xtrain_googSR = XgoogWithoutSentiments[inTrain_googSR,]
Xtest_googSR  = XgoogWithoutSentiments[-inTrain_googSR,]
Xtrain_googSRdummy = XgoogWithoutSentiments[inTrain_googSRdummy,]
Xtest_googSRdummy  = XgoogWithoutSentiments[-inTrain_googSRdummy,]

```


```{r setupFinalTask}

#Repeated cross validation
trControl = caret::trainControl(method = "repeatedcv", repeats = 5, number = 10)

XtrainMat_tslaHL      = as.matrix(Xtrain_tslaHL)
XtestMat_tslaHL       = as.matrix(Xtest_tslaHL)
XtrainMat_tslaSR      = as.matrix(Xtrain_tslaSR)
XtestMat_tslaSR       = as.matrix(Xtest_tslaSR)
XtrainMat_tslaSRdummy = as.matrix(Xtrain_tslaSRdummy)
XtestMat_tslaSRdummy  = as.matrix(Xtest_tslaSRdummy)

####GOOG
#Feature transformations
XtrainMat_googHL      = as.matrix(Xtrain_googHL)
XtestMat_googHL       = as.matrix(Xtest_googHL)
XtrainMat_googSR      = as.matrix(Xtrain_googSR)
XtestMat_googSR       = as.matrix(Xtest_googSR)
XtrainMat_googSRdummy = as.matrix(Xtrain_googSRdummy)
XtestMat_googSRdummy  = as.matrix(Xtest_googSRdummy)

#Parallelism
#cl = parallel::makeCluster(8)
#doParallel::registerDoParallel(cl)
```


```{r elasticNetTuningParameters}
set.seed(2020)
cl = parallel::makeCluster(8)
doParallel::registerDoParallel(cl)
####Supervisor Y1 = YtslaWithSentiments$diffHighLowTomorrow
####TSLA
trControl = caret::trainControl(method = "repeatedcv", repeats = 5, number = 10)

lassoGridTslaHL = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutTslaHL = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL, 
                       method = 'glmnet',
                       tuneGrid = lassoGridTslaHL, 
                       trControl = trControl)
plot(elasticOutTslaHL, main = "Elastic Net - TSLA diffHighLow")

####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

lassoGridGoogHL = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutGoogHL = train(x = XtrainMat_googHL, y = Ytrain_googHL, 
                       method = 'glmnet',
                       tuneGrid = lassoGridGoogHL, 
                       trControl = trControl)
plot(elasticOutGoogHL, main = "Elastic Net - GOOG diffHighLow")



####Supervisor Y2 = YtslaWithSentiments$stockReturnTomorrow
####TSLA
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

lassoGridTslaSR = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutTslaSR = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR, 
                       method = 'glmnet',
                       tuneGrid = lassoGridTslaSR, 
                       trControl = trControl)
plot(elasticOutTslaSR, main = "Elastic Net - TSLA stockReturn")

####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

lassoGridGoogSR = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutGoogSR = train(x = XtrainMat_googSR, y = Ytrain_googSR, 
                       method = 'glmnet',
                       tuneGrid = lassoGridGoogSR, 
                       trControl = trControl)
plot(elasticOutGoogSR, main = "Elastic Net - GOOG stockReturn")


#List of turning parameters
tunePara = rbind(
  elasticOutTslaHL$bestTune,
  elasticOutTslaSR$bestTune,
  elasticOutGoogHL$bestTune,
  elasticOutGoogSR$bestTune
  )

row.names(tunePara) = c("TSLA - diffHighLow", "TSLA - stockReturn",
                "GOOG - diffHighLow", "GOOG - stockReturn")

knitr::kable(
 tunePara,
 col.names = c("alpha","lambda"),
 caption   = "Table 1: Optimal tuning parameters for Elastic Penalized  regression",
 align     = "lccrr"
)

```


```{r elasticNet}
####Supervisor Y1 = YtslaStandardizedWithDummy$diffHighLowTomorrow
####TSLA
glmnetOutTslaHL       = glmnet(x = XtrainMat_tslaHL, y = Ytrain_tslaHL, 
                               alpha = elasticOutTslaHL$bestTune$alpha)
betaHatGlmnetTslaHL   = coef(glmnetOutTslaHL, 
                             s = elasticOutTslaHL$bestTune$lambda)
YhatTrainGlmnetTslaHL = predict(glmnetOutTslaHL, XtrainMat_tslaHL, 
                                s = elasticOutTslaHL$bestTune$lambda)

residualsTslaHL = Ytrain_tslaHL - YhatTrainGlmnetTslaHL
plot(YhatTrainGlmnetTslaHL, residualsTslaHL, 
     xlab = "Traning predictions - TSLA diffHighLow",
     ylab = "Residuals", main = "Residual Plot - TSLA diffHighLow")

####GOOG
glmnetOutGoogHL       = glmnet(x = XtrainMat_googHL, y = Ytrain_googHL, 
                               alpha = elasticOutGoogHL$bestTune$alpha)
betaHatGlmnetGoogHL   = coef(glmnetOutGoogHL, 
                             s = elasticOutGoogHL$bestTune$lambda)
YhatTrainGlmnetGoogHL = predict(glmnetOutGoogHL, XtrainMat_googHL, 
                                s = elasticOutGoogHL$bestTune$lambda )

residualsGoogHL = Ytrain_googHL - YhatTrainGlmnetGoogHL
plot(YhatTrainGlmnetGoogHL, residualsGoogHL, 
     xlab = "Traning predictions - GOOG diffHighLow",
     ylab = "Residuals", main = "Residual Plot - GOOG diffHighLow")

####Supervisor Y2 = YtslaStandardizedWithDummy$stockReturnTomorrow
####TSLA
glmnetOutTslaSR       = glmnet(x = XtrainMat_tslaSR, y = Ytrain_tslaSR, 
                               alpha = elasticOutTslaSR$bestTune$alpha)
betaHatGlmnetTslaSR   = coef(glmnetOutTslaSR, 
                             s = elasticOutTslaSR$bestTune$lambda)
YhatTrainGlmnetTslaSR = predict(glmnetOutTslaSR, XtrainMat_tslaSR, 
                                s = elasticOutTslaSR$bestTune$lambda)

residualsTslaSR = Ytrain_tslaSR - YhatTrainGlmnetTslaSR
plot(YhatTrainGlmnetTslaSR, residualsTslaSR, 
     xlab = "Traning predictions - TSLA Stock Return",
     ylab = "Residuals", main = "Residual Plot - TSLA stockReturn")

####GOOG
glmnetOutGoogSR       = glmnet(x = XtrainMat_googSR, y = Ytrain_googSR,
                               alpha = elasticOutGoogSR$bestTune$alpha)
betaHatGlmnetGoogSR   = coef(glmnetOutGoogSR, 
                             s = elasticOutGoogSR$bestTune$lambda)
YhatTrainGlmnetGoogSR = predict(glmnetOutGoogSR, XtrainMat_googSR, 
                                s = elasticOutGoogSR$bestTune$lambda)

residualsGoogSR = Ytrain_googSR - YhatTrainGlmnetGoogSR
plot(YhatTrainGlmnetGoogSR, residualsGoogSR, 
     xlab = "Traning predictions - GOOG Stock Return",
     ylab = "Residuals", main = "Residual Plot - GOOG stockReturn")

```

####Logistic Classification
```{r logisticClassification}
set.seed(2020)
trControl = caret::trainControl(method = "repeatedcv", repeats = 5, number = 10)
tuneGridTslaSRdummy = expand.grid('alpha' = c(0,.25,.5,.75,1),
                                  'lambda' = seq(0.000001, .001, length.out = 30))
elasticOutTslaSRdummy = train(x = Xtrain_tslaSRdummy, 
                              y = as.factor(Ytrain_tslaSRdummy),
                              method = 'glmnet',
                              trControl = trControl, 
                              tuneGrid = tuneGridTslaSRdummy)
elasticOutTslaSRdummy$bestTune$alpha

glmnetOutTslaSRdummy = glmnet(x = XtrainMat_tslaSRdummy, 
                              y = as.factor(Ytrain_tslaSRdummy),
                              alpha = 0.25,
                              family = 'binomial')
probHatTest_TslaSRdummy = predict(glmnetOutTslaSRdummy, XtestMat_tslaSRdummy,
                                  s = elasticOutTslaSRdummy$bestTune$lambda,
                                  type = 'response')

YhatTestGlmnet_TslaSRdummy = ifelse(probHatTest_TslaSRdummy > 0.5, '1', '0')
YhatTest_TslaSRdummy       = predict(elasticOutTslaSRdummy,XtestMat_tslaSRdummy,
                                     s = elasticOutTslaSRdummy$lambda, 
                                     type = 'raw')

#Cross-check they're the same. #Lecture 23 notes.
table(YhatTest_TslaSRdummy,YhatTest_TslaSRdummy)

betaHatGlmnetTslaSRdummy = coef(glmnetOutTslaSRdummy, 
                                s = elasticOutTslaSRdummy$bestTune$lambda)
#Accuracy
accuracyLinear_TslaSRdummy = mean(YhatTest_TslaSRdummy==Ytest_tslaSRdummy)
probHatTest_TslaSRdummy_ = predict(elasticOutTslaSRdummy,XtestMat_tslaSRdummy,
                                   s = elasticOutTslaSRdummy$bestTune$lambda,
                                   type = 'prob')
rocOut_TslaSRdummy = pROC::roc(response = Ytest_tslaSRdummy,                   
                               probHatTest_TslaSRdummy_[,2])

plot(rocOut_TslaSRdummy, main = "ROC Plot - TSLA Stock Return (Dummy)")


####GOOG
set.seed(2020)

tuneGridGoogSRdummy = expand.grid('alpha' = c(0,.25,.5,.75,1),
                                  'lambda' = seq(0.000001, .001, length.out = 30))
elasticOutGoogSRdummy = train(x = Xtrain_googSRdummy, 
                              y = as.factor(Ytrain_googSRdummy),
                              method = 'glmnet',
                              trControl = trControl, 
                              tuneGrid = tuneGridGoogSRdummy)
elasticOutGoogSRdummy$bestTune$alpha

glmnetOutGoogSRdummy = glmnet(x = XtrainMat_googSRdummy, 
                              y = as.factor(Ytrain_googSRdummy),
                              alpha = 0.25,
                              family = 'binomial')
probHatTest_GoogSRdummy = predict(glmnetOutGoogSRdummy, XtestMat_googSRdummy,
                                  s = elasticOutGoogSRdummy$bestTune$lambda,
                                  type = 'response')

YhatTestGlmnet_GoogSRdummy = ifelse(probHatTest_GoogSRdummy > 0.5, '1', '0')
YhatTest_GoogSRdummy       = predict(elasticOutGoogSRdummy,XtestMat_googSRdummy,
                                     s = elasticOutGoogSRdummy$lambda, 
                                     type = 'raw')

#Cross-check they're the same. #Lecture 23 notes.
table(YhatTest_GoogSRdummy,YhatTest_GoogSRdummy)

betaHatGlmnetGoogSRdummy = coef(glmnetOutGoogSRdummy, 
                                s = elasticOutGoogSRdummy$bestTune$lambda)
#Accuracy
accuracyLinear_GoogSRdummy = mean(YhatTest_GoogSRdummy==Ytest_googSRdummy)
probHatTest_GoogSRdummy_ = predict(elasticOutGoogSRdummy,XtestMat_googSRdummy,
                                   s = elasticOutGoogSRdummy$bestTune$lambda,
                                   type = 'prob')
rocOut_GoogSRdummy = pROC::roc(response = Ytest_googSRdummy,                   
                               probHatTest_GoogSRdummy_[,2])

plot(rocOut_GoogSRdummy, main = "ROC Plot - GOOG Stock Return (Dummy)")



#List of Accuracy
accuracyLinear = rbind(
  accuracyLinear_TslaSRdummy,
  accuracyLinear_GoogSRdummy
  )

row.names(accuracyLinear) = c("TSLA - Stock Return(dummy)", 
                "GOOG - Stock Return(dummy)")

knitr::kable(
 accuracyLinear,
 col.names = c("Accuracy based on Testing data"),
 caption   = "Table 2: Accuracy - Logistic Elastic Net",
 align     = "lccrr"
)

```

####Nonlinear Methods

####MARS
```{r MARS_Task3}
set.seed(2020)
#trControl = caret::trainControl(method = "repeatedcv", repeats = 5, number = 10)

###TSLA
tuneGridTslaHL      = expand.grid(degree = 1:3,
                                  nprune = 10:35)

tuneGridTslaSR      = expand.grid(degree = 1:3,
                                  nprune = 10:35)

tuneGridTslaSRdummy = expand.grid(degree = 1:3,
                                  nprune = c(10,20,50,100))

marsOutTslaHL = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridTslaHL,
                      trControl = trControl)
marsOutTslaHL$bestTune

plot(marsOutTslaHL, main = "MARS Regression - TSLA diffHighLow")
ggplot(marsOutTslaHL)+labs( title= "MARS Regression - TSLA diffHighLow")

marsOutTslaSR = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridTslaSR,
                      trControl = trControl)
marsOutTslaSR$bestTune
plot(marsOutTslaSR, main = "MARS Regression - TSLA stockReturn")

trControl_tslaSRdummy = caret::trainControl(method = "repeatedcv", repeats = 2, 
                                number = 10, classProbs = TRUE)
Ytrain_tslaSRdummy_ = as.factor(Ytrain_tslaSRdummy[Ytrain_tslaSRdummy == '1'|
                                                   Ytrain_tslaSRdummy == '0'])
Ytrain_tslaSRdummy_ = relevel(Ytrain_tslaSRdummy_, ref = '0')


levels(Ytrain_tslaSRdummy_) = c("No", "Yes")

marsOutTslaSRdummy = train(x = XtrainMat_tslaSRdummy, 
                           y = Ytrain_tslaSRdummy_,
                      method = 'fda',
                      metric = 'Accuracy',
                      tuneGrid = tuneGridTslaSRdummy,
                      trControl = trControl_tslaSRdummy)
marsOutTslaSRdummy$bestTune
plot(marsOutTslaSRdummy)

#YhatTestFDA_TslaSRdummyProb = predict(marsOutTslaSRdummy, Xtest_tslaSRdummy,
                                  #type = 'prob')
#YhatTestFDA_TslaSRdummy     = ifelse(YhatTestFDA_TslaSRdummyProb[,2] > 0.5, '1','0')

#table(YhatTestFDA_TslaSRdummy, Ytest_tslaSRdummy)

###GOOG
#Y1
tuneGridGoogHL      = expand.grid(degree = 1:3,
                                  nprune = 10:35)
marsOutGoogHL = train(x = XtrainMat_googHL, y = Ytrain_googHL,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridGoogHL,
                      trControl = trControl)
marsOutGoogHL$bestTune
ggplot(marsOutGoogHL)+labs( title= "MARS Regression - GOOG diffHighLow")

#summary(marsOutGoogHL) %>% .$coefficients %>% head(10)


#Y2
tuneGridGoogSR      = expand.grid(degree = 1:3,
                                  nprune = 10:35)
marsOutGoogSR = train(x = XtrainMat_googSR, y = Ytrain_googSR,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridGoogSR,
                      trControl = trControl)
marsOutGoogSR$bestTune
plot(marsOutGoogSR, main = "MARS Regression - GOOG stockReturn")
#Y3
tuneGridGoogSRdummy = expand.grid(degree = 1:3,
                                  nprune = c(10,20,50,100))
trControl_googSRdummy = caret::trainControl(method = "repeatedcv", repeats = 2, 
                                number = 10, classProbs = TRUE)
Ytrain_googSRdummy_ = as.factor(Ytrain_googSRdummy[Ytrain_googSRdummy == '1'|
                                                   Ytrain_googSRdummy == '0'])
Ytrain_googSRdummy_ = relevel(Ytrain_googSRdummy_, ref = '0')


levels(Ytrain_googSRdummy_) = c("No", "Yes")

marsOutGoogSRdummy = train(x = XtrainMat_googSRdummy, 
                           y = Ytrain_googSRdummy_,
                      method = 'fda',
                      metric = 'Accuracy',
                      tuneGrid = tuneGridGoogSRdummy,
                      trControl = trControl_googSRdummy)

marsOutGoogSRdummy$bestTune
plot(marsOutGoogSRdummy)

#YhatTestFDA_GoogSRdummyProb = predict(marsOutGoogSRdummy, Xtest_googSRdummy,
                                  #type = 'prob')
#YhatTestFDA_GoogSRdummy     = ifelse(YhatTestFDA_GoogSRdummyProb[,2] > 0.5, '1','0')

#table(YhatTestFDA_GoogSRdummy, Ytest_googSRdummy)



###Summary
ggplot(marsOutTslaHL)+labs( title= "MARS Regression - TSLA diffHighLow")
ggplot(marsOutTslaSR)+labs( title= "MARS Regression - TSLA stockReturn")
ggplot(marsOutTslaSRdummy)+labs(title= "MARS Classification - TSLA stockReturn(dummy)")
ggplot(marsOutGoogHL)+labs( title= "MARS Regression - GOOG diffHighLow")
ggplot(marsOutGoogSR)+labs( title= "MARS Regression - GOOG stockReturn")
ggplot(marsOutGoogSRdummy)+labs(title= "MARS Classification - GOOG stockReturn(dummy)")

#List of Tuning Parameters
tuneParaMars = rbind(
  marsOutTslaHL$bestTune,
  marsOutTslaSR$bestTune,
  marsOutTslaSRdummy$bestTune,
  marsOutGoogHL$bestTune,
  marsOutGoogSR$bestTune,
  marsOutGoogSRdummy$bestTune
  )


row.names(tuneParaMars) = c("TSLA - diffHighLow", "TSLA - stockReturn", 
                            "TSLA - stockReturn(Dummy)","GOOG - diffHighLow", 
                            "GOOG - stockReturn","GOOG - stockReturn(Dummy)")

knitr::kable(
 tuneParaMars,
 col.names = c("nprune", "degree"),
 caption   = "Table 3: MARS regression and Classification - Tuning Parameters",
 align     = "lccrr"
)

#Importance

marsTslaHLvip = vip(marsOutTslaHL, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: TSLA - diffHighLow")
plot(marsTslaHLvip)

marsTslaSRvip = vip(marsOutTslaSR, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: TSLA - stockReturn")
plot(marsTslaSRvip)

marsTslaSRdummyvip = vip(marsOutTslaSRdummy, num_features = 50, bar = FALSE, value = "gcv") + ggtitle("Plot of Variable Importance: TSLA - stockReturn(dummy)")
plot(marsTslaSRdummyvip)


marsGoogHLvip = vip(marsOutGoogHL, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: GOOG - diffHighLow")
plot(marsGoogHLvip)

marsGoogSRvip = vip(marsOutGoogSR, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: GOOG - stockReturn")
plot(marsGoogSRvip)

marsGoogSRdummyvip = vip(marsOutGoogSRdummy, num_features = 50, bar = FALSE, value = "gcv") + ggtitle("Plot of Variable Importance: GOOG - stockReturn(dummy)")
plot(marsGoogSRdummyvip)


```

####Classification Tree

```{r classificationTree}
set.seed(2022)
cl = parallel::makeCluster(8)
doParallel::registerDoParallel(cl)
####TSLA
#trControl = caret::trainControl(method = "repeatedcv", repeats = 5, 
#                                number = 10, classProbs = TRUE)
#Y1
tuneGridTree_TslaHL = expand.grid(cp = c(0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_TslaHL     = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL,
                            method = "rpart",
                            tuneGrid = tuneGridTree_TslaHL,
                            trControl = trControl)
plot(rpartOut_TslaHL$finalModel, margin = rep(.1,4),
     main = "Classification Tree - TSLA diffHighLow")
text(rpartOut_TslaHL$finalModel, cex = 0.6, digits = 1)
#Y2
tuneGridTree_TslaSR = expand.grid(cp = c(0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_TslaSR     = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR,
                            method = "rpart",
                            tuneGrid = tuneGridTree_TslaSR,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, minbucket = 1))
rpartOut_TslaSR$finalModel #just a root
#plot(rpartOut_TslaSR$finalModel, margin = rep(.1,4))
#text(rpartOut_TslaSR$finalModel, cex = 0.6, digits = 1)


#Y3
tuneGridTree_TslaSRdummy = expand.grid(cp = c(0,0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_TslaSRdummy     = train(x = XtrainMat_tslaSRdummy, 
                                 y = Ytrain_tslaSRdummy_,
                            method = "rpart",
                            #parms = list(prior = c(.65,.35),split = "gini"),
                            parms = list(split = "gini"),
                            tuneGrid = tuneGridTree_TslaSRdummy,
                            trControl = trControl)
plot(rpartOut_TslaSRdummy$finalModel, margin = rep(.1,4),
     main = "Classification Tree - TSLA stockReturn(dummy)")
text(rpartOut_TslaSRdummy$finalModel, cex = 0.6, digits = 1)



####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 5, 
                               # number = 10, classProbs = TRUE)
#Y1
tuneGridTree_GoogHL = expand.grid(cp = c(0,0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_GoogHL     = train(x = XtrainMat_googHL, y = Ytrain_googHL,
                            method = "rpart",
                            tuneGrid = tuneGridTree_GoogHL,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, 
                                                    minbucket = 1))
plot(rpartOut_GoogHL$finalModel, margin = rep(.1,4),
     main = "Classification Tree - GOOG diffHighLow")
text(rpartOut_GoogHL$finalModel, cex = 0.6, digits = 1)
#Y2
tuneGridTree_GoogSR = expand.grid(cp = c(0,0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_GoogSR     = train(x = XtrainMat_googSR, y = Ytrain_googSR,
                            method = "rpart",
                            tuneGrid = tuneGridTree_GoogSR,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, minbucket = 1))
rpartOut_GoogSR$finalModel #just a root
#plot(rpartOut_GoogSR$finalModel, margin = rep(.1,4))
#text(rpartOut_TslaSR$finalModel, cex = 0.6, digits = 1)


#Y3
tuneGridTree_GoogSRdummy = expand.grid(cp = c(0,0.0001,0.001,0.01,0.05,0.1,0.15,1))
rpartOut_GoogSRdummy     = train(x = XtrainMat_googSRdummy, 
                                 y = Ytrain_googSRdummy_,
                            method = "rpart",
                            parms = list(split = "gini"),
                            tuneGrid = tuneGridTree_GoogSRdummy,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, minbucket = 1))
#one root
rpartOut_GoogSRdummy$finalModel
#plot(rpartOut_GoogSRdummy$finalModel, margin = rep(.1,4))
#text(rpartOut_GoogSRdummy$finalModel, cex = 0.6, digits = 1)


```

####Random Forest

```{r randomForest}
set.seed(2020)
cl = parallel::makeCluster(8)
doParallel::registerDoParallel(cl)
####TSLA
#trControl = caret::trainControl(method = "repeatedcv", repeats = 5, 
#                                number = 10, classProbs = TRUE)
#Y1
tuneGridRanger_TslaHL = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_tslaHL))))
rfOut_tslaHL  = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_TslaHL, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_tslaHL$finalModel
#print(rfOut_tslaHL)
#Y2
tuneGridRanger_TslaSR = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_tslaSR))))
rfOut_tslaSR  = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_TslaSR, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_tslaSR$finalModel

#Y3
tuneGridRanger_TslaSRdummy = data.frame(splitrule = "gini", min.node.size = 10,
                                   mtry = round(sqrt(ncol(Xtrain_tslaSRdummy))))
rfOut_tslaSRdummy  = train(x = XtrainMat_tslaSRdummy, 
                           y = as.matrix(Ytrain_tslaSRdummy) , 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_TslaSRdummy, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_tslaSRdummy$finalModel

####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 5, 
#                                number = 10, classProbs = TRUE)
#Y1
tuneGridRanger_GoogHL = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_googHL))))
rfOut_googHL  = train(x = XtrainMat_googHL, y = Ytrain_googHL, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_GoogHL, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_googHL$finalModel

#Y2
tuneGridRanger_GoogSR = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_googSR))))
rfOut_googSR  = train(x = XtrainMat_googSR, y = Ytrain_googSR, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_GoogSR, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_googSR$finalModel

#Y3
head(Ytrain_googSRdummy_)
length(Ytrain_googSRdummy_)
tuneGridRanger_GoogSRdummy = data.frame(splitrule = "gini", min.node.size = 10,
                                   mtry = round(sqrt(ncol(Xtrain_googSRdummy))))
rfOut_googSRdummy  = train(x = XtrainMat_googSRdummy, y =as.matrix(Ytrain_googSRdummy_), 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_GoogSRdummy, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_googSRdummy$finalModel


#List of Tuning Parameters
tuneParaRF = rbind(
  rfOut_tslaHL$bestTune,
  rfOut_tslaSR$bestTune,
  rfOut_tslaSRdummy$bestTune,
  rfOut_googHL$bestTune,
  rfOut_googSR$bestTune,
  rfOut_googSRdummy$bestTune
  )


row.names(tuneParaRF) = c("TSLA - diffHighLow", "TSLA - stockReturn", 
                            "TSLA - stockReturn(Dummy)","GOOG - diffHighLow", 
                            "GOOG - stockReturn","GOOG - stockReturn(Dummy)")

knitr::kable(
 tuneParaRF,
 col.names = c("mtry", "splitrule", "min.node.size"),
 caption   = "Table 4: Random Forest regression and Classification - Tuning Parameters",
 align     = "lccrr"
)

```

####Boosting

```{r boosting}
set.seed(2020)
cl = parallel::makeCluster(8)
doParallel::registerDoParallel(cl)
####TSLA
#Y1
tuneGridRandom_TslaHL = expand.grid('nrounds'= c(50,150,500,1000,2000,3000),
                                   'max_depth' = 6,
                                   'eta' = c(0.01,0.03,0.05),
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = c(0.5, 0.8))

boostOutRandom_TslaHL = train(x = Xtrain_tslaHL, y = Ytrain_tslaHL,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_TslaHL,
                              trControl = trControl)
plot(boostOutRandom_TslaHL)

#Y2

tuneGridRandom_TslaSR = expand.grid('nrounds'= c(50,150,500,1000,2000,3000),
                                   'max_depth' = 6,
                                   'eta' = c(0.01,0.03,0.05),
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = c(0.5, 0.8))

boostOutRandom_TslaSR = train(x = Xtrain_tslaSR, y = Ytrain_tslaSR,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_TslaSR,
                              trControl = trControl)
plot(boostOutRandom_TslaSR)
boostOutRandom_TslaSR$bestTune$nrounds

#Y3
cl = parallel::makeCluster(8)
doParallel::registerDoParallel(cl)
tuneGridRandom_TslaSRdummy = expand.grid(
                                   'nrounds'= c(50,150,500,1000,2000,3000),
                                   'max_depth' = 6,
                                   'eta' = c(0.01,0.03,0.05),
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = c(0.5, 0.8))

boostOutRandom_TslaSRdummy = train(x = Xtrain_tslaSRdummy, 
                                   y = Ytrain_tslaSRdummy_,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_TslaSRdummy,
                              trControl = trControl)
plot(boostOutRandom_TslaSRdummy)






####GOOG
#Y1
tuneGridRandom_GoogHL = expand.grid('nrounds'= c(50,150,500,1000,2000,3000),
                                   'max_depth' = 6,
                                   'eta' = c(0.01,0.03,0.05),
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = c(0.5, 0.8))

boostOutRandom_GoogHL = train(x = Xtrain_googHL, y = Ytrain_googHL,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_GoogHL,
                              trControl = trControl)
plot(boostOutRandom_GoogHL)

#Y2
tuneGridRandom_GoogSR = expand.grid('nrounds'= c(50,150,500,1000,2000,3000),
                                   'max_depth' = 6,
                                   'eta' = c(0.01,0.03,0.05),
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = c(0.5, 0.8))

boostOutRandom_GoogSR = train(x = Xtrain_googSR, y = Ytrain_googSR,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_GoogSR,
                              trControl = trControl)
plot(boostOutRandom_GoogSR)
boostOutRandom_GoogSR$bestTune$nrounds

#Y3
tuneGridRandom_GoogSRdummy = expand.grid(
                                   'nrounds'= c(50,150,500,1000,2000,3000),
                                   'max_depth' = 6,
                                   'eta' = c(0.01,0.03,0.05),
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = c(0.5, 0.8))

boostOutRandom_GoogSRdummy = train(x = Xtrain_googSRdummy, 
                                   y = Ytrain_googSRdummy_,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_GoogSRdummy,
                              trControl = trControl)
plot(boostOutRandom_GoogSRdummy)

boostOutRandom_GoogSRdummy$bestTune

###Overview

plot(boostOutRandom_TslaHL, main = "Boosting: TSLA diffHighLow")
plot(boostOutRandom_TslaSR, main = "Boosting: TSLA stockReturn")
plot(boostOutRandom_TslaSRdummy, main = "Boosting: TSLA stockReturn(Dummy)")

plot(boostOutRandom_GoogHL, main = "Boosting: GOOG diffHighLow")
plot(boostOutRandom_GoogSR, main = "Boosting: GOOG stockReturn")
plot(boostOutRandom_GoogSRdummy, main = "Boosting: GOOG stockReturn(Dummy)")


#List of Tuning Parameters
tuneParaBoost = rbind(
  boostOutRandom_TslaHL$bestTune,
  boostOutRandom_TslaSR$bestTune,
  boostOutRandom_TslaSRdummy$bestTune,
  boostOutRandom_GoogHL$bestTune,
  boostOutRandom_GoogSR$bestTune,
  boostOutRandom_GoogSRdummy$bestTune
  )


row.names(tuneParaBoost) = c("TSLA - diffHighLow", "TSLA - stockReturn", 
                            "TSLA - stockReturn(Dummy)","GOOG - diffHighLow", 
                            "GOOG - stockReturn","GOOG - stockReturn(Dummy)")

knitr::kable(
 tuneParaBoost,
 col.names = c("nrounds","max_depth","eta","gamma","colsample_bytree",
               "min_child_weight","subsample"),
 caption   = "Table 5: Boosting regression and Classification - Tuning Parameters",
 align     = "lccrr"
)

```

####Performance Review

```{r importanceBoosting}
####TSLA
(boostImportance_TslaHL = xgboost::xgb.importance(model = boostOutRandom_TslaHL$finalModel))

(boostImportance_TslaSR = xgboost::xgb.importance(model = boostOutRandom_TslaSR$finalModel))

(boostImportance_TslaSRdummy = xgboost::xgb.importance(model = boostOutRandom_TslaSRdummy$finalModel))

####GOOG
(boostImportance_GoogHL = xgboost::xgb.importance(model = boostOutRandom_GoogHL$finalModel))

(boostImportance_GoogSR = xgboost::xgb.importance(model = boostOutRandom_GoogSR$finalModel))

(boostImportance_GoogSRdummy = xgboost::xgb.importance(model = boostOutRandom_GoogSRdummy$finalModel))
```

```{r judgePerformance}
set.seed(2020)
################Regression
####TSLA
#Y1
resultsTest_TslaHL  = data.frame(
  YhatGlmnet = c(predict(glmnetOutTslaHL, XtestMat_tslaHL,
                         s = elasticOutTslaHL$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutTslaHL, XtestMat_tslaHL)),
  YhatTrees  = predict(rpartOut_TslaHL, XtestMat_tslaHL),
  YhatRF     = predict(rfOut_tslaHL, XtestMat_tslaHL),
  YhatBoost  = predict(boostOutRandom_TslaHL, XtestMat_tslaHL)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_TslaHL), 
     sapply(resultsTest_TslaHL, function(Yhat){mean((Yhat - Ytest_tslaHL)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'TSLA - Supervisor = difference between highest and lowest prices')
axis(1, labels = names(resultsTest_TslaHL), at = 1:ncol(resultsTest_TslaHL), las = 3)

#Y2
resultsTest_TslaSR  = data.frame(
  YhatGlmnet = c(predict(glmnetOutTslaSR, XtestMat_tslaSR,
                         s = elasticOutTslaSR$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutTslaSR, XtestMat_tslaSR)),
  YhatTrees  = predict(rpartOut_TslaSR, XtestMat_tslaSR),
  YhatRF     = predict(rfOut_tslaSR, XtestMat_tslaSR),
  YhatBoost  = predict(boostOutRandom_TslaSR, XtestMat_tslaSR)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_TslaSR), 
     sapply(resultsTest_TslaSR, function(Yhat){mean((Yhat - Ytest_tslaSR)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'TSLA - Supervisor = stock return')
axis(1, labels = names(resultsTest_TslaSR), at = 1:ncol(resultsTest_TslaSR), las = 3)

####GOOG
#Y1
resultsTest_GoogHL  = data.frame(
  YhatGlmnet = c(predict(glmnetOutGoogHL, XtestMat_googHL,
                         s = elasticOutGoogHL$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutGoogHL, XtestMat_googHL)),
  YhatTrees  = predict(rpartOut_GoogHL, XtestMat_googHL),
  YhatRF     = predict(rfOut_googHL, XtestMat_googHL),
  YhatBoost  = predict(boostOutRandom_GoogHL, XtestMat_googHL)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_GoogHL), 
     sapply(resultsTest_GoogHL, function(Yhat){mean((Yhat - Ytest_googHL)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'GOOG - Supervisor = difference between highest and lowest prices')
axis(1, labels = names(resultsTest_GoogHL), at = 1:ncol(resultsTest_GoogHL), las = 3)

#Y2
resultsTest_GoogSR  = data.frame(
  YhatGlmnet = c(predict(glmnetOutGoogSR, XtestMat_googSR,
                         s = elasticOutGoogSR$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutGoogSR, XtestMat_googSR)),
  YhatTrees  = predict(rpartOut_GoogSR, XtestMat_googSR),
  YhatRF     = predict(rfOut_googSR, XtestMat_googSR),
  YhatBoost  = predict(boostOutRandom_GoogSR, XtestMat_googSR)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_GoogSR), 
     sapply(resultsTest_GoogSR, function(Yhat){mean((Yhat - Ytest_googSR)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'GOOG - Supervisor = stock return')
axis(1, labels = names(resultsTest_GoogSR), at = 1:ncol(resultsTest_GoogSR), las = 3)










###################Classification
####TSLA
#TSLA MARS(FDA)- Y3
YhatTestFDA_TslaSRdummyProb = predict(marsOutTslaSRdummy, Xtest_tslaSRdummy,
                                  type = 'prob')
YhatTestFDA_TslaSRdummy     = ifelse(YhatTestFDA_TslaSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestFDA_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyFDA = sum(diag(table(YhatTestFDA_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#TSLA Classification Tree - Y3
YhatTestTree_TslaSRdummyProb = predict(rpartOut_TslaSRdummy, Xtest_tslaSRdummy,
                                  type = 'prob')
YhatTestTree_TslaSRdummy     = ifelse(YhatTestTree_TslaSRdummyProb[,2] > 0.5, '1','0')
table(YhatTestTree_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyTree = sum(diag(table(YhatTestTree_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#TSLA Random Forest - Y3

YhatTestRF_TslaSRdummyProb = predict(rfOut_tslaSRdummy, XtestMat_tslaSRdummy,
                                  type = 'prob')
YhatTestRF_TslaSRdummy     = ifelse(YhatTestRF_TslaSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestRF_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyRF = sum(diag(table(YhatTestRF_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#TSLA Boosting - Y3
YhatTestBoost_TslaSRdummyProb = predict(boostOutRandom_TslaSRdummy,
                                        XtestMat_tslaSRdummy,type = 'prob')
YhatTestBoost_TslaSRdummy     = ifelse(YhatTestBoost_TslaSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestBoost_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyBoost = sum(diag(table(YhatTestBoost_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#Summary - TSLA - Classification
resultsTestClass_Tsla = data.frame(
  accuracyFDA  = TslaSRdummy_accuracyFDA,
  accuracyTree = TslaSRdummy_accuracyTree,
  accuracyRF = TslaSRdummy_accuracyRF,
  accuracyBoost = TslaSRdummy_accuracyBoost
)
par(mar=c(7,5,4,2))
plot(1:length(resultsTestClass_Tsla), 
     resultsTestClass_Tsla,
     xlab = '', xaxt = 'n', pch = 16, ylab = 'accuracy', 
     main = 'TSLA - Supervisor = stock return (dummy)')
axis(1, labels = names(resultsTestClass_Tsla), at = 1:ncol(resultsTestClass_Tsla), las = 3)


####GOOG
#GOOG MARS(FDA) - Y3
YhatTestFDA_GoogSRdummyProb = predict(marsOutGoogSRdummy, Xtest_googSRdummy,
                                  type = 'prob')

YhatTestFDA_GoogSRdummy     = ifelse(YhatTestFDA_GoogSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestFDA_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyFDA = sum(diag(table(YhatTestFDA_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))

#GOOG Classification Tree - Y3
YhatTestTree_GoogSRdummyProb = predict(rpartOut_GoogSRdummy, Xtest_googSRdummy,
                                  type = 'prob')
YhatTestTree_GoogSRdummy     = ifelse(YhatTestTree_GoogSRdummyProb[,2] > 0.5, '1','0')
table(YhatTestTree_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyTree = sum(diag(table(YhatTestTree_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))

#GOOG Random Forest - Y3
YhatTestRF_GoogSRdummyProb = predict(rfOut_googSRdummy, Xtest_googSRdummy,
                                  type = 'prob')

YhatTestRF_GoogSRdummy     = ifelse(YhatTestRF_GoogSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestRF_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyRF = sum(diag(table(YhatTestRF_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))


#GOOG Boosting - Y3
YhatTestBoost_GoogSRdummyProb = predict(boostOutRandom_GoogSRdummy,
                                        XtestMat_googSRdummy,type = 'prob')
YhatTestBoost_GoogSRdummy     = ifelse(YhatTestBoost_GoogSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestBoost_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyBoost = sum(diag(table(YhatTestBoost_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))


#Summary - GOOG - Classification
resultsTestClass_Goog = data.frame(
  accuracyFDA   = GoogSRdummy_accuracyFDA,
  accuracyTree  = GoogSRdummy_accuracyTree,
  accuracyRF    = GoogSRdummy_accuracyRF,
  accuracyBoost = GoogSRdummy_accuracyBoost
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTestClass_Goog), 
     resultsTestClass_Goog,
     xlab = '', xaxt = 'n', pch = 16,  ylab = 'accuracy', 
     main = 'GOOG - Supervisor = stock return (dummy)')
axis(1, labels = names(resultsTestClass_Goog), at = 1:ncol(resultsTestClass_Goog), las = 3)




```







































###### 8 - Final Task with sentiments (updated from Task 3) 

```{r data}
tslaAddVolTrendRemoveNA = tslaAddVolTrend %>%
  na.omit(.)
tslaFullStandardized =  tslaAddVolTrendRemoveNA %>%
  caret::preProcess(method = c("center","scale")) %>%
  predict(newdata =tslaAddVolTrendRemoveNA)


###TSLA
tslaY  = tslaFullStandardized %>%
  dplyr::select(Date,diffHighLow, stockReturn) %>%
  dplyr::as_tibble() %>%
  dplyr::slice(-1) %>%
  mutate(stockReturnDummy = if_else(stockReturn >= 0, 1, 0))

tslaX    = tslaFullStandardized %>%
  .[1:(nrow(.)-1),] %>%
  dplyr::as_tibble(.) 

names(tslaY)[2] = "diffHighLowTomorrow" #Y1
names(tslaY)[3] = "stockReturnTomorrow" #Y2
names(tslaY)[4] = "stockReturnTomorrowDummy" #Y3
nrow(tslaX)
nrow(tslaY)
#####Dummy Variables
###TSLA
XtslaAddLevels = tslaX %>%
  mutate(aboveR1 = factor(ifelse(PX_HIGH > R1, "Yes", "No"))) %>%
  mutate(aboveR2 = factor(ifelse(PX_HIGH > R2, "Yes", "No"))) %>%
  mutate(aboveR3 = factor(ifelse(PX_HIGH > R3, "Yes", "No"))) %>%
  mutate(belowS1 = factor(ifelse(PX_LOW  < S1, "Yes", "No"))) %>%
  mutate(belowS2 = factor(ifelse(PX_LOW  < S2, "Yes", "No"))) %>%
  mutate(belowS3 = factor(ifelse(PX_LOW  < S3, "Yes", "No"))) %>%
  select(aboveR1, aboveR2, aboveR3, belowS1, belowS2, belowS3)            
XtslaDummyModel = caret::dummyVars(~ ., data = XtslaAddLevels, fullRank = TRUE)

nrow(XtslaAddLevels)

YtslaAddLevels = as_tibble(factor(ifelse(tslaY$stockReturnTomorrow > 0, "Increased", "Decreased"))) 
YtslaDummyModel = caret::dummyVars(~ ., data = YtslaAddLevels, fullRank = TRUE)



XtslaDummy = as_tibble(predict(XtslaDummyModel, XtslaAddLevels))

YtslaDummy = as_tibble(predict(YtslaDummyModel, YtslaAddLevels))
names(YtslaDummy)[1] = "stockReturnTomorrowDummy" #Y2

nrow(XtslaDummy)
nrow(YtslaDummy)

#tslaFullWithDummy = tslaFullStandardized %>% 
#  mutate(XtslaDummy) %>% 
#  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3) %>% 
#  #Drop PP, R1, R2, R3, S1, S2, S3 
#  mutate(YtslaDummy) 

XtslaWithDummy = tslaX %>%
  mutate(XtslaDummy) %>% 
  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3)

XtslaWithoutDummy = tslaX %>%
  dplyr::select(-R1,-S1,-R2,-S2,-R3,-S3)

YtslaWithDummy = tslaY %>% mutate(YtslaDummy) 








#Correlation between stock data of today and difference between highest and lowest stock prices on tomorrow is much higher than correlation between stock data of today and daily stock return on tomorrow. Thus, it's suggested to use "diffHighLowTomorrow " as the supervisor in model fitting.

#summary(tslaY$diffHighLowTomorrow)

##GOOG
googY  = googAddVolTrend %>%
  na.omit() %>%
  dplyr::select(diffHighLow, stockReturn) %>%
  dplyr::as_tibble() %>%
  dplyr::slice(-1) %>%
  mutate(stockReturnDummy = if_else(stockReturn >= 0, 1, 0))


googX    = googAddVolTrend %>%
  na.omit() %>%
  .[1:(nrow(.)-1),] %>%
  dplyr::as_tibble(.) 

names(googY)[1] = "diffHighLowTomorrow" #Y1
names(googY)[2] = "stockReturnTomorrow" #Y2
names(googY)[3] = "stockReturnTomorrowDummy" #Y3

googFull = dplyr::as_tibble(cbind(googY,googX))

```




```{r dataTransformation Task3}
#See {r dummyVarForLogisticRegression}
####TSLA
#Feature transformations
#First, standardize all numeric features
tslaXStandardized = XtslaWithoutDummy %>% #tslaX contains only numeric features
  caret::preProcess(method = c("center","scale")) %>%
  predict(newdata = XtslaWithoutDummy)

XtslaStandardizedWithDummy = tslaXStandardized %>%
  cbind(.,XtslaDummy) #add dummy variables back to data set

tslaYnumeric = tslaY %>% select(diffHighLowTomorrow, stockReturnTomorrow)
YtslaStandardizedWithDummy = tslaYnumeric %>%
  caret::preProcess(method = c("center","scale")) %>%
  predict(newdata = tslaYnumeric) %>%
  cbind(.,YtslaDummy) #add dummy variables back to data set

highCorrTsla = highCorrF(XtslaStandardizedWithDummy,0.8)
XtslaLinear = XtslaStandardizedWithDummy %>% select(-highCorrTsla)
        #Standardized, WithDummy, RemoveCorr

####GOOG
#Feature transformations
#First, standardize all numeric features
googXStandardized = XgoogWithoutDummy %>% #tslaX contains only numeric features
  caret::preProcess(method = c("center","scale")) %>%
  predict(newdata = XgoogWithoutDummy)

XgoogStandardizedWithDummy = googXStandardized %>%
  cbind(.,XgoogDummy) #add dummy variables back to data set

googYnumeric = googY %>% select(diffHighLowTomorrow, stockReturnTomorrow)
YgoogStandardizedWithDummy = googYnumeric %>%
  caret::preProcess(method = c("center","scale")) %>%
  predict(newdata = googYnumeric) %>%
  cbind(.,YgoogDummy) #add dummy variables back to data set

  
highCorrGoog = highCorrF(XgoogStandardizedWithDummy,0.8)
XgoogLinear = XgoogStandardizedWithDummy %>% select(-highCorrGoog)
        #Standardized, WithDummy, RemoveCorr

#XtslaStandardizedWithDummy
#YtslaStandardizedWithDummy
#XgoogStandardizedWithDummy
#YgoogStandardizedWithDummy
```

```{r dataSplitTask3}
#Line 990
#Superviors:
  #Y1: YtslaStandardizedWithDummy$diffHighLowTomorrow
  #Y2: YtslaStandardizedWithDummy$stockReturnTomorrow
  #Y3: YtslaStandardizedWithDummy$stockReturnTomorrowDummy

#Features:
  #XtslaStandardizedWithDummy

#Full set:
  #tslaFull

set.seed(2020)
inTrain_tslaHL = caret::createDataPartition(YtslaStandardizedWithDummy$diffHighLowTomorrow, p = 3/4, list = FALSE) #Y1
inTrain_tslaSR = caret::createDataPartition(YtslaStandardizedWithDummy$stockReturnTomorrow, p = 3/4, list = FALSE) #Y2
inTrain_tslaSRdummy = caret::createDataPartition(YtslaStandardizedWithDummy$stockReturnTomorrowDummy, p = 3/4, list = FALSE) #Y3

Ytrain_tslaHL = YtslaStandardizedWithDummy$diffHighLowTomorrow[inTrain_tslaHL]
Ytest_tslaHL  = YtslaStandardizedWithDummy$diffHighLowTomorrow[-inTrain_tslaHL]
Ytrain_tslaSR = YtslaStandardizedWithDummy$stockReturnTomorrow[inTrain_tslaSR]
Ytest_tslaSR  = YtslaStandardizedWithDummy$stockReturnTomorrow[-inTrain_tslaSR]
Ytrain_tslaSRdummy = YtslaStandardizedWithDummy$stockReturnTomorrowDummy[inTrain_tslaSRdummy]
Ytest_tslaSRdummy  = YtslaStandardizedWithDummy$stockReturnTomorrowDummy[-inTrain_tslaSRdummy]

Xtrain_tslaHL = XtslaStandardizedWithDummy[inTrain_tslaHL,] 
Xtest_tslaHL  = XtslaStandardizedWithDummy[-inTrain_tslaHL,]
Xtrain_tslaSR = XtslaStandardizedWithDummy[inTrain_tslaSR,] 
Xtest_tslaSR  = XtslaStandardizedWithDummy[-inTrain_tslaSR,]
Xtrain_tslaSRdummy = XtslaStandardizedWithDummy[inTrain_tslaSRdummy,]
Xtest_tslaSRdummy  = XtslaStandardizedWithDummy[-inTrain_tslaSRdummy,]

###GOOG
inTrain_googHL = caret::createDataPartition(YgoogStandardizedWithDummy$diffHighLowTomorrow, p = 3/4, list = FALSE) #Y1
inTrain_googSR = caret::createDataPartition(YgoogStandardizedWithDummy$stockReturnTomorrow, p = 3/4, list = FALSE) #Y2
inTrain_googSRdummy = caret::createDataPartition(YgoogStandardizedWithDummy$stockReturnTomorrowDummy, p = 3/4, list = FALSE) #Y3

Ytrain_googHL = YgoogStandardizedWithDummy$diffHighLowTomorrow[inTrain_googHL]
Ytest_googHL  = YgoogStandardizedWithDummy$diffHighLowTomorrow[-inTrain_googHL]
Ytrain_googSR = YgoogStandardizedWithDummy$stockReturnTomorrow[inTrain_googSR]
Ytest_googSR  = YgoogStandardizedWithDummy$stockReturnTomorrow[-inTrain_googSR]
Ytrain_googSRdummy = YgoogStandardizedWithDummy$stockReturnTomorrowDummy[inTrain_googSRdummy]
Ytest_googSRdummy  = YgoogStandardizedWithDummy$stockReturnTomorrowDummy[-inTrain_googSRdummy]

Xtrain_googHL = XgoogStandardizedWithDummy[inTrain_googHL,]
Xtest_googHL  = XgoogStandardizedWithDummy[-inTrain_googHL,]
Xtrain_googSR = XgoogStandardizedWithDummy[inTrain_googSR,]
Xtest_googSR  = XgoogStandardizedWithDummy[-inTrain_googSR,]
Xtrain_googSRdummy = XgoogStandardizedWithDummy[inTrain_googSRdummy,]
Xtest_googSRdummy  = XgoogStandardizedWithDummy[-inTrain_googSRdummy,]

```

```{r dataReview}
####TSLA
caret::featurePlot(Xtrain_tslaHL[,1:10], Ytrain_tslaHL)
caret::featurePlot(Xtrain_tslaSR[,1:10], Ytrain_tslaSR)
caret::featurePlot(Xtrain_tslaSRdummy[,1:10], Ytrain_tslaSRdummy)

caret::featurePlot(Xtrain_tslaHL[,11:20], Ytrain_tslaHL)
caret::featurePlot(Xtrain_tslaSR[,11:20], Ytrain_tslaSR)
caret::featurePlot(Xtrain_tslaSRdummy[,11:20], Ytrain_tslaSRdummy)

caret::featurePlot(Xtrain_tslaHL[,21:30], Ytrain_tslaHL)
caret::featurePlot(Xtrain_tslaSR[,21:30], Ytrain_tslaSR)
caret::featurePlot(Xtrain_tslaSRdummy[,21:30], Ytrain_tslaSRdummy)

caret::featurePlot(Xtrain_tslaHL[,31:40], Ytrain_tslaHL)
caret::featurePlot(Xtrain_tslaSR[,31:40], Ytrain_tslaSR)
caret::featurePlot(Xtrain_tslaSRdummy[,31:40], Ytrain_tslaSRdummy)

caret::featurePlot(Xtrain_tslaHL[,41:56], Ytrain_tslaHL)
caret::featurePlot(Xtrain_tslaSR[,41:56], Ytrain_tslaSR)
caret::featurePlot(Xtrain_tslaSRdummy[,41:56], Ytrain_tslaSRdummy)


####GOOG
caret::featurePlot(Xtrain_googHL[,1:10], Ytrain_googHL)
caret::featurePlot(Xtrain_googSR[,1:10], Ytrain_googSR)
caret::featurePlot(Xtrain_googSRdummy[,1:10], Ytrain_googSRdummy)

caret::featurePlot(Xtrain_googHL[,11:20], Ytrain_googHL)
caret::featurePlot(Xtrain_googSR[,11:20], Ytrain_googSR)
caret::featurePlot(Xtrain_googSRdummy[,11:20], Ytrain_googSRdummy)

caret::featurePlot(Xtrain_googHL[,21:30], Ytrain_googHL)
caret::featurePlot(Xtrain_googSR[,21:30], Ytrain_googSR)
caret::featurePlot(Xtrain_googSRdummy[,21:30], Ytrain_googSRdummy)

caret::featurePlot(Xtrain_googHL[,31:40], Ytrain_googHL)
caret::featurePlot(Xtrain_googSR[,31:40], Ytrain_googSR)
caret::featurePlot(Xtrain_googSRdummy[,31:40], Ytrain_googSRdummy)

caret::featurePlot(Xtrain_googHL[,41:54], Ytrain_googHL)
caret::featurePlot(Xtrain_googSR[,41:54], Ytrain_googSR)
caret::featurePlot(Xtrain_googSRdummy[,41:54], Ytrain_googSRdummy)
```

```{r setupTask3}

#Repeated cross validation
trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

XtrainMat_tslaHL      = as.matrix(Xtrain_tslaHL)
XtestMat_tslaHL       = as.matrix(Xtest_tslaHL)
XtrainMat_tslaSR      = as.matrix(Xtrain_tslaSR)
XtestMat_tslaSR       = as.matrix(Xtest_tslaSR)
XtrainMat_tslaSRdummy = as.matrix(Xtrain_tslaSRdummy)
XtestMat_tslaSRdummy  = as.matrix(Xtest_tslaSRdummy)

####GOOG
#Feature transformations
XtrainMat_googHL      = as.matrix(Xtrain_googHL)
XtestMat_googHL       = as.matrix(Xtest_googHL)
XtrainMat_googSR      = as.matrix(Xtrain_googSR)
XtestMat_googSR       = as.matrix(Xtest_googSR)
XtrainMat_googSRdummy = as.matrix(Xtrain_googSRdummy)
XtestMat_googSRdummy  = as.matrix(Xtest_googSRdummy)

#Parallelism
cl = parallel::makeCluster(2)
doParallel::registerDoParallel(cl)
```


```{r linearTuningParameters}
set.seed(2020)

####Supervisor Y1 = YtslaStandardizedWithDummy$diffHighLowTomorrow
####TSLA
trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

lassoGridTslaHL = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutTslaHL = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL, 
                       method = 'glmnet',
                       tuneGrid = lassoGridTslaHL, 
                       trControl = trControl)
plot(elasticOutTslaHL, main = "Elastic Net - TSLA diffHighLow")

####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

lassoGridGoogHL = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutGoogHL = train(x = XtrainMat_googHL, y = Ytrain_googHL, 
                       method = 'glmnet',
                       tuneGrid = lassoGridGoogHL, 
                       trControl = trControl)
plot(elasticOutGoogHL, main = "Elastic Net - GOOG diffHighLow")



####Supervisor Y2 = YtslaStandardizedWithDummy$stockReturnTomorrow
####TSLA
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

lassoGridTslaSR = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutTslaSR = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR, 
                       method = 'glmnet',
                       tuneGrid = lassoGridTslaSR, 
                       trControl = trControl)
plot(elasticOutTslaSR, main = "Elastic Net - TSLA stockReturn")

####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

lassoGridGoogSR = expand.grid(lambda = c(0.0001,0.001, 0.01, 0.05, 0.1, 0.2),
                            alpha = c(0.05,0.5,1))


elasticOutGoogSR = train(x = XtrainMat_googSR, y = Ytrain_googSR, 
                       method = 'glmnet',
                       tuneGrid = lassoGridGoogSR, 
                       trControl = trControl)
plot(elasticOutGoogSR, main = "Elastic Net - GOOG stockReturn")


#List of turning parameters
tunePara = rbind(
  elasticOutTslaHL$bestTune,
  elasticOutTslaSR$bestTune,
  elasticOutGoogHL$bestTune,
  elasticOutGoogSR$bestTune
  )

row.names(tunePara) = c("TSLA - diffHighLow", "TSLA - stockReturn",
                "GOOG - diffHighLow", "GOOG - stockReturn")

knitr::kable(
 tunePara,
 col.names = c("alpha","lambda"),
 caption   = "Table 1: Optimal tuning parameters for linear regression",
 align     = "lccrr"
)

```


```{r linearModelPenalized}
####Supervisor Y1 = YtslaStandardizedWithDummy$diffHighLowTomorrow
####TSLA
glmnetOutTslaHL       = glmnet(x = XtrainMat_tslaHL, y = Ytrain_tslaHL, 
                               alpha = elasticOutTslaHL$bestTune$alpha)
betaHatGlmnetTslaHL   = coef(glmnetOutTslaHL, 
                             s = elasticOutTslaHL$bestTune$lambda)
YhatTrainGlmnetTslaHL = predict(glmnetOutTslaHL, XtrainMat_tslaHL, 
                                s = elasticOutTslaHL$bestTune$lambda)

residualsTslaHL = Ytrain_tslaHL - YhatTrainGlmnetTslaHL
plot(YhatTrainGlmnetTslaHL, residualsTslaHL, 
     xlab = "Traning predictions - TSLA diffHighLow",
     ylab = "Residuals", main = "Residual Plot - TSLA diffHighLow")

####GOOG
glmnetOutGoogHL       = glmnet(x = XtrainMat_googHL, y = Ytrain_googHL, 
                               alpha = elasticOutGoogHL$bestTune$alpha)
betaHatGlmnetGoogHL   = coef(glmnetOutGoogHL, 
                             s = elasticOutGoogHL$bestTune$lambda)
YhatTrainGlmnetGoogHL = predict(glmnetOutGoogHL, XtrainMat_googHL, 
                                s = elasticOutGoogHL$bestTune$lambda )

residualsGoogHL = Ytrain_googHL - YhatTrainGlmnetGoogHL
plot(YhatTrainGlmnetGoogHL, residualsGoogHL, 
     xlab = "Traning predictions - GOOG diffHighLow",
     ylab = "Residuals", main = "Residual Plot - GOOG diffHighLow")

####Supervisor Y2 = YtslaStandardizedWithDummy$stockReturnTomorrow
####TSLA
glmnetOutTslaSR       = glmnet(x = XtrainMat_tslaSR, y = Ytrain_tslaSR, 
                               alpha = elasticOutTslaSR$bestTune$alpha)
betaHatGlmnetTslaSR   = coef(glmnetOutTslaSR, 
                             s = elasticOutTslaSR$bestTune$lambda)
YhatTrainGlmnetTslaSR = predict(glmnetOutTslaSR, XtrainMat_tslaSR, 
                                s = elasticOutTslaSR$bestTune$lambda)

residualsTslaSR = Ytrain_tslaSR - YhatTrainGlmnetTslaSR
plot(YhatTrainGlmnetTslaSR, residualsTslaSR, 
     xlab = "Traning predictions - TSLA Stock Return",
     ylab = "Residuals", main = "Residual Plot - TSLA stockReturn")

####GOOG
glmnetOutGoogSR       = glmnet(x = XtrainMat_googSR, y = Ytrain_googSR,
                               alpha = elasticOutGoogSR$bestTune$alpha)
betaHatGlmnetGoogSR   = coef(glmnetOutGoogSR, 
                             s = elasticOutGoogSR$bestTune$lambda)
YhatTrainGlmnetGoogSR = predict(glmnetOutGoogSR, XtrainMat_googSR, 
                                s = elasticOutGoogSR$bestTune$lambda)

residualsGoogSR = Ytrain_googSR - YhatTrainGlmnetGoogSR
plot(YhatTrainGlmnetGoogSR, residualsGoogSR, 
     xlab = "Traning predictions - GOOG Stock Return",
     ylab = "Residuals", main = "Residual Plot - GOOG stockReturn")

```

####Logistic Classification
```{r logisticClassification}
set.seed(2020)
K = 10
trainControl = trainControl(method = 'cv', number = K)
tuneGridTslaSRdummy = expand.grid('alpha' = c(0,.25,.5,.75,1),
                                  'lambda' = seq(0.000001, .001, length.out = 30))
elasticOutTslaSRdummy = train(x = Xtrain_tslaSRdummy, 
                              y = as.factor(Ytrain_tslaSRdummy),
                              method = 'glmnet',
                              trControl = trainControl, 
                              tuneGrid = tuneGridTslaSRdummy)
elasticOutTslaSRdummy$bestTune$alpha

glmnetOutTslaSRdummy = glmnet(x = XtrainMat_tslaSRdummy, 
                              y = as.factor(Ytrain_tslaSRdummy),
                              alpha = 0.25,
                              family = 'binomial')
probHatTest_TslaSRdummy = predict(glmnetOutTslaSRdummy, XtestMat_tslaSRdummy,
                                  s = elasticOutTslaSRdummy$bestTune$lambda,
                                  type = 'response')

YhatTestGlmnet_TslaSRdummy = ifelse(probHatTest_TslaSRdummy > 0.5, '1', '0')
YhatTest_TslaSRdummy       = predict(elasticOutTslaSRdummy,XtestMat_tslaSRdummy,
                                     s = elasticOutTslaSRdummy$lambda, 
                                     type = 'raw')

#Cross-check they're the same. #Lecture 23 notes.
table(YhatTest_TslaSRdummy,YhatTest_TslaSRdummy)

betaHatGlmnetTslaSRdummy = coef(glmnetOutTslaSRdummy, 
                                s = elasticOutTslaSRdummy$bestTune$lambda)
#Accuracy
accuracyLinear_TslaSRdummy = mean(YhatTest_TslaSRdummy==Ytest_tslaSRdummy)
probHatTest_TslaSRdummy_ = predict(elasticOutTslaSRdummy,XtestMat_tslaSRdummy,
                                   s = elasticOutTslaSRdummy$bestTune$lambda,
                                   type = 'prob')
rocOut_TslaSRdummy = pROC::roc(response = Ytest_tslaSRdummy,                   
                               probHatTest_TslaSRdummy_[,2])

plot(rocOut_TslaSRdummy, main = "ROC Plot - TSLA Stock Return (Dummy)")


####GOOG
set.seed(2020)
K = 10
trainControl = trainControl(method = 'cv', number = K)
tuneGridGoogSRdummy = expand.grid('alpha' = c(0,.25,.5,.75,1),
                                  'lambda' = seq(0.000001, .001, length.out = 30))
elasticOutGoogSRdummy = train(x = Xtrain_googSRdummy, 
                              y = as.factor(Ytrain_googSRdummy),
                              method = 'glmnet',
                              trControl = trainControl, 
                              tuneGrid = tuneGridGoogSRdummy)
elasticOutGoogSRdummy$bestTune$alpha

glmnetOutGoogSRdummy = glmnet(x = XtrainMat_googSRdummy, 
                              y = as.factor(Ytrain_googSRdummy),
                              alpha = 0.25,
                              family = 'binomial')
probHatTest_GoogSRdummy = predict(glmnetOutGoogSRdummy, XtestMat_googSRdummy,
                                  s = elasticOutGoogSRdummy$bestTune$lambda,
                                  type = 'response')

YhatTestGlmnet_GoogSRdummy = ifelse(probHatTest_GoogSRdummy > 0.5, '1', '0')
YhatTest_GoogSRdummy       = predict(elasticOutGoogSRdummy,XtestMat_googSRdummy,
                                     s = elasticOutGoogSRdummy$lambda, 
                                     type = 'raw')

#Cross-check they're the same. #Lecture 23 notes.
table(YhatTest_GoogSRdummy,YhatTest_GoogSRdummy)

betaHatGlmnetGoogSRdummy = coef(glmnetOutGoogSRdummy, 
                                s = elasticOutGoogSRdummy$bestTune$lambda)
#Accuracy
accuracyLinear_GoogSRdummy = mean(YhatTest_GoogSRdummy==Ytest_googSRdummy)
probHatTest_GoogSRdummy_ = predict(elasticOutGoogSRdummy,XtestMat_googSRdummy,
                                   s = elasticOutGoogSRdummy$bestTune$lambda,
                                   type = 'prob')
rocOut_GoogSRdummy = pROC::roc(response = Ytest_googSRdummy,                   
                               probHatTest_GoogSRdummy_[,2])

plot(rocOut_GoogSRdummy, main = "ROC Plot - GOOG Stock Return (Dummy)")



#List of Accuracy
accuracyLinear = rbind(
  accuracyLinear_TslaSRdummy,
  accuracyLinear_GoogSRdummy
  )

row.names(accuracyLinear) = c("TSLA - Stock Return(dummy)", 
                "GOOG - Stock Return(dummy)")

knitr::kable(
 accuracyLinear,
 col.names = c("Accuracy based on Testing data"),
 caption   = "Table 2: Accuracy - Logistic Elastic Net",
 align     = "lccrr"
)

```

####Nonlinear Methods

#####MARS
```{r MARS_Task3}
set.seed(2020)
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, number = 10)

###TSLA
tuneGridTslaHL      = expand.grid(degree = 1:3,
                                  nprune = 10:35)

tuneGridTslaSR      = expand.grid(degree = 1:3,
                                  nprune = 10:35)

tuneGridTslaSRdummy = expand.grid(degree = 1:3,
                                  nprune = c(10,20,50,100))

marsOutTslaHL = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridTslaHL,
                      trControl = trControl)
marsOutTslaHL$bestTune

plot(marsOutTslaHL, main = "MARS Regression - TSLA diffHighLow")
ggplot(marsOutTslaHL)+labs( title= "MARS Regression - TSLA diffHighLow")

marsOutTslaSR = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridTslaSR,
                      trControl = trControl)
marsOutTslaSR$bestTune
plot(marsOutTslaSR, main = "MARS Regression - TSLA stockReturn")

trControl_tslaSRdummy = caret::trainControl(method = "repeatedcv", repeats = 2, 
                                number = 10, classProbs = TRUE)
Ytrain_tslaSRdummy_ = as.factor(Ytrain_tslaSRdummy[Ytrain_tslaSRdummy == '1'|
                                                   Ytrain_tslaSRdummy == '0'])
Ytrain_tslaSRdummy_ = relevel(Ytrain_tslaSRdummy_, ref = '0')


levels(Ytrain_tslaSRdummy_) = c("No", "Yes")
marsOutTslaSRdummy = train(x = XtrainMat_tslaSRdummy, 
                           y = Ytrain_tslaSRdummy_,
                      method = 'fda',
                      metric = 'Accuracy',
                      tuneGrid = tuneGridTslaSRdummy,
                      trControl = trControl_tslaSRdummy)
marsOutTslaSRdummy$bestTune
plot(marsOutTslaSRdummy)

#YhatTestFDA_TslaSRdummyProb = predict(marsOutTslaSRdummy, Xtest_tslaSRdummy,
                                  #type = 'prob')
#YhatTestFDA_TslaSRdummy     = ifelse(YhatTestFDA_TslaSRdummyProb[,2] > 0.5, '1','0')

#table(YhatTestFDA_TslaSRdummy, Ytest_tslaSRdummy)

###GOOG
#Y1
tuneGridGoogHL      = expand.grid(degree = 1:3,
                                  nprune = 10:35)
marsOutGoogHL = train(x = XtrainMat_googHL, y = Ytrain_googHL,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridGoogHL,
                      trControl = trControl)
marsOutGoogHL$bestTune
ggplot(marsOutGoogHL)+labs( title= "MARS Regression - GOOG diffHighLow")

#summary(marsOutGoogHL) %>% .$coefficients %>% head(10)


#Y2
tuneGridGoogSR      = expand.grid(degree = 1:3,
                                  nprune = 10:35)
marsOutGoogSR = train(x = XtrainMat_googSR, y = Ytrain_googSR,
                      method = 'earth', metric = 'RMSE',
                      tuneGrid = tuneGridGoogSR,
                      trControl = trControl)
marsOutGoogSR$bestTune
plot(marsOutGoogSR, main = "MARS Regression - GOOG stockReturn")
#Y3
tuneGridGoogSRdummy = expand.grid(degree = 1:3,
                                  nprune = c(10,20,50,100))
trControl_googSRdummy = caret::trainControl(method = "repeatedcv", repeats = 2, 
                                number = 10, classProbs = TRUE)
Ytrain_googSRdummy_ = as.factor(Ytrain_googSRdummy[Ytrain_googSRdummy == '1'|
                                                   Ytrain_googSRdummy == '0'])
Ytrain_googSRdummy_ = relevel(Ytrain_googSRdummy_, ref = '0')


levels(Ytrain_googSRdummy_) = c("No", "Yes")

marsOutGoogSRdummy = train(x = XtrainMat_googSRdummy, 
                           y = Ytrain_googSRdummy_,
                      method = 'fda',
                      metric = 'Accuracy',
                      tuneGrid = tuneGridGoogSRdummy,
                      trControl = trControl_googSRdummy)

marsOutGoogSRdummy$bestTune
plot(marsOutGoogSRdummy)

#YhatTestFDA_GoogSRdummyProb = predict(marsOutGoogSRdummy, Xtest_googSRdummy,
                                  #type = 'prob')
#YhatTestFDA_GoogSRdummy     = ifelse(YhatTestFDA_GoogSRdummyProb[,2] > 0.5, '1','0')

#table(YhatTestFDA_GoogSRdummy, Ytest_googSRdummy)



###Summary
ggplot(marsOutTslaHL)+labs( title= "MARS Regression - TSLA diffHighLow")
ggplot(marsOutTslaSR)+labs( title= "MARS Regression - TSLA stockReturn")
ggplot(marsOutTslaSRdummy)+labs(title= "MARS Classification - TSLA stockReturn(dummy)")
ggplot(marsOutGoogHL)+labs( title= "MARS Regression - GOOG diffHighLow")
ggplot(marsOutGoogSR)+labs( title= "MARS Regression - GOOG stockReturn")
ggplot(marsOutGoogSRdummy)+labs(title= "MARS Classification - GOOG stockReturn(dummy)")

#List of Tuning Parameters
tuneParaMars = rbind(
  marsOutTslaHL$bestTune,
  marsOutTslaSR$bestTune,
  marsOutTslaSRdummy$bestTune,
  marsOutGoogHL$bestTune,
  marsOutGoogSR$bestTune,
  marsOutGoogSRdummy$bestTune
  )


row.names(tuneParaMars) = c("TSLA - diffHighLow", "TSLA - stockReturn", 
                            "TSLA - stockReturn(Dummy)","GOOG - diffHighLow", 
                            "GOOG - stockReturn","GOOG - stockReturn(Dummy)")

knitr::kable(
 tuneParaMars,
 col.names = c("nprune", "degree"),
 caption   = "Table 3: MARS regression and Classification - Tuning Parameters",
 align     = "lccrr"
)

#Importance

marsTslaHLvip = vip(marsOutTslaHL, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: TSLA - diffHighLow")
plot(marsTslaHLvip)

marsTslaSRvip = vip(marsOutTslaSR, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: TSLA - stockReturn")
plot(marsTslaSRvip)

marsTslaSRdummyvip = vip(marsOutTslaSRdummy, num_features = 50, bar = FALSE, value = "gcv") + ggtitle("Plot of Variable Importance: TSLA - stockReturn(dummy)")
plot(marsTslaSRdummyvip)


marsGoogHLvip = vip(marsOutGoogHL, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: GOOG - diffHighLow")
plot(marsGoogHLvip)

marsGoogSRvip = vip(marsOutGoogSR, num_features = 50, bar = FALSE, value = "gcv") +
  ggtitle("Plot of Variable Importance: GOOG - stockReturn")
plot(marsGoogSRvip)

marsGoogSRdummyvip = vip(marsOutGoogSRdummy, num_features = 50, bar = FALSE, value = "gcv") + ggtitle("Plot of Variable Importance: GOOG - stockReturn(dummy)")
plot(marsGoogSRdummyvip)


```

#####Classification Tree

```{r classificationTree}
set.seed(2022)
####TSLA
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, 
#                                number = 10, classProbs = TRUE)
#Y1
tuneGridTree_TslaHL = expand.grid(cp = c(0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_TslaHL     = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL,
                            method = "rpart",
                            tuneGrid = tuneGridTree_TslaHL,
                            trControl = trControl)
plot(rpartOut_TslaHL$finalModel, margin = rep(.1,4),
     main = "Classification Tree - TSLA diffHighLow")
text(rpartOut_TslaHL$finalModel, cex = 0.6, digits = 1)
#Y2
tuneGridTree_TslaSR = expand.grid(cp = c(0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_TslaSR     = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR,
                            method = "rpart",
                            tuneGrid = tuneGridTree_TslaSR,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, minbucket = 1))
rpartOut_TslaSR$finalModel #just a root
#plot(rpartOut_TslaSR$finalModel, margin = rep(.1,4))
#text(rpartOut_TslaSR$finalModel, cex = 0.6, digits = 1)


#Y3
tuneGridTree_TslaSRdummy = expand.grid(cp = c(0,0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_TslaSRdummy     = train(x = XtrainMat_tslaSRdummy, 
                                 y = Ytrain_tslaSRdummy_,
                            method = "rpart",
                            #parms = list(prior = c(.65,.35),split = "gini"),
                            parms = list(split = "gini"),
                            tuneGrid = tuneGridTree_TslaSRdummy,
                            trControl = trControl)
plot(rpartOut_TslaSRdummy$finalModel, margin = rep(.1,4),
     main = "Classification Tree - TSLA stockReturn(dummy)")
text(rpartOut_TslaSRdummy$finalModel, cex = 0.6, digits = 1)



####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, 
                               # number = 10, classProbs = TRUE)
#Y1
tuneGridTree_GoogHL = expand.grid(cp = c(0,0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_GoogHL     = train(x = XtrainMat_googHL, y = Ytrain_googHL,
                            method = "rpart",
                            tuneGrid = tuneGridTree_GoogHL,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, 
                                                    minbucket = 1))
plot(rpartOut_GoogHL$finalModel, margin = rep(.1,4),
     main = "Classification Tree - GOOG diffHighLow")
text(rpartOut_GoogHL$finalModel, cex = 0.6, digits = 1)
#Y2
tuneGridTree_GoogSR = expand.grid(cp = c(0,0.0001,0.001,0.01,0.1,0.15,0.5,1))
rpartOut_GoogSR     = train(x = XtrainMat_googSR, y = Ytrain_googSR,
                            method = "rpart",
                            tuneGrid = tuneGridTree_GoogSR,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, minbucket = 1))
rpartOut_GoogSR$finalModel #just a root
#plot(rpartOut_GoogSR$finalModel, margin = rep(.1,4))
#text(rpartOut_TslaSR$finalModel, cex = 0.6, digits = 1)


#Y3
tuneGridTree_GoogSRdummy = expand.grid(cp = c(0,0.0001,0.001,0.01,0.05,0.1,0.15,1))
rpartOut_GoogSRdummy     = train(x = XtrainMat_googSRdummy, 
                                 y = Ytrain_googSRdummy_,
                            method = "rpart",
                            parms = list(split = "gini"),
                            tuneGrid = tuneGridTree_GoogSRdummy,
                            trControl = trControl,
                            control = rpart.control(minsplit = 1, minbucket = 1))
#one root
rpartOut_GoogSRdummy$finalModel
#plot(rpartOut_GoogSRdummy$finalModel, margin = rep(.1,4))
#text(rpartOut_GoogSRdummy$finalModel, cex = 0.6, digits = 1)


```

#####Random Forest

```{r randomForest}
set.seed(2020)
####TSLA
trControl = caret::trainControl(method = "repeatedcv", repeats = 2, 
                                number = 10, classProbs = TRUE)
#Y1
tuneGridRanger_TslaHL = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_tslaHL))))
rfOut_tslaHL  = train(x = XtrainMat_tslaHL, y = Ytrain_tslaHL, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_TslaHL, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_tslaHL$finalModel
#print(rfOut_tslaHL)
#Y2
tuneGridRanger_TslaSR = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_tslaSR))))
rfOut_tslaSR  = train(x = XtrainMat_tslaSR, y = Ytrain_tslaSR, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_TslaSR, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_tslaSR$finalModel

#Y3
tuneGridRanger_TslaSRdummy = data.frame(splitrule = "gini", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_tslaSRdummy))))
rfOut_tslaSRdummy  = train(x = XtrainMat_tslaSRdummy, 
                           y = as.matrix(Ytrain_tslaSRdummy_) , 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_TslaSRdummy, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_tslaSRdummy$finalModel

####GOOG
#trControl = caret::trainControl(method = "repeatedcv", repeats = 2, 
#                                number = 10, classProbs = TRUE)
#Y1
tuneGridRanger_GoogHL = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_googHL))))
rfOut_googHL  = train(x = XtrainMat_googHL, y = Ytrain_googHL, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_GoogHL, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_googHL$finalModel

#Y2
tuneGridRanger_GoogSR = data.frame(splitrule = "variance", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_googSR))))
rfOut_googSR  = train(x = XtrainMat_googSR, y = Ytrain_googSR, 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_GoogSR, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_googSR$finalM

#Y3
tuneGridRanger_GoogSRdummy = data.frame(splitrule = "gini", min.node.size = 5,
                                   mtry = round(sqrt(ncol(Xtrain_googSRdummy))))
rfOut_googSRdummy  = train(x = XtrainMat_googSRdummy, y =as.matrix(Ytrain_googSRdummy_), 
                      method = "ranger",
                      num.trees = 500,
                      tuneGrid = tuneGridRanger_GoogSRdummy, 
                      importance = "permutation",
                      trControl = trControl)
rfOut_googSRdummy$finalModel


#List of Tuning Parameters
tuneParaRF = rbind(
  rfOut_tslaHL$bestTune,
  rfOut_tslaSR$bestTune,
  rfOut_tslaSRdummy$bestTune,
  rfOut_googHL$bestTune,
  rfOut_googSR$bestTune,
  rfOut_googSRdummy$bestTune
  )


row.names(tuneParaRF) = c("TSLA - diffHighLow", "TSLA - stockReturn", 
                            "TSLA - stockReturn(Dummy)","GOOG - diffHighLow", 
                            "GOOG - stockReturn","GOOG - stockReturn(Dummy)")

knitr::kable(
 tuneParaRF,
 col.names = c("mtry", "splitrule", "min.node.size"),
 caption   = "Table 4: Random Forest regression and Classification - Tuning Parameters",
 align     = "lccrr"
)

```

#####Boosting

```{r boosting}
set.seed(2020)
####TSLA
#Y1
tuneGridRandom_TslaHL = data.frame('nrounds'= c(50,150,500,1000,2000,3000),
                                   'max_depth' = 6,
                                   'eta' = 0.05,
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = 0.5)

boostOutRandom_TslaHL = train(x = Xtrain_tslaHL, y = Ytrain_tslaHL,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_TslaHL,
                              trControl = trControl)
plot(boostOutRandom_TslaHL)

#Y2
tuneGridRandom_TslaSR = data.frame('nrounds'= c(1,5,10,15,25,35,45,50,55),
                                   'max_depth' = 6,
                                   'eta' = 0.05,
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = 0.5)

boostOutRandom_TslaSR = train(x = Xtrain_tslaSR, y = Ytrain_tslaSR,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_TslaSR,
                              trControl = trControl)
plot(boostOutRandom_TslaSR)
boostOutRandom_TslaSR$bestTune$nrounds

#Y3
tuneGridRandom_TslaSRdummy = data.frame(
                                   'nrounds'= c(50,150,500,1000,2000,3000,4000),
                                   'max_depth' = 6,
                                   'eta' = 0.05,
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = 0.5)

boostOutRandom_TslaSRdummy = train(x = Xtrain_tslaSRdummy, 
                                   y = Ytrain_tslaSRdummy_,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_TslaSRdummy,
                              trControl = trControl)
plot(boostOutRandom_TslaSRdummy)






####GOOG
#Y1
tuneGridRandom_GoogHL = data.frame('nrounds'= c(5,25,50,60,65,70,75,80,100),
                                   'max_depth' = 6,
                                   'eta' = 0.05,
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = 0.5)

boostOutRandom_GoogHL = train(x = Xtrain_googHL, y = Ytrain_googHL,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_GoogHL,
                              trControl = trControl)
plot(boostOutRandom_GoogHL)

#Y2
tuneGridRandom_GoogSR = data.frame('nrounds'= c(1,5,10,15,25,35,45,50,55,100),
                                   'max_depth' = 6,
                                   'eta' = 0.05,
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = 0.5)

boostOutRandom_GoogSR = train(x = Xtrain_googSR, y = Ytrain_googSR,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_GoogSR,
                              trControl = trControl)
plot(boostOutRandom_GoogSR)
boostOutRandom_GoogSR$bestTune$nrounds

#Y3
tuneGridRandom_GoogSRdummy = data.frame(
                                   'nrounds'= c(50,1500,2000,3000,3500,4000),
                                   'max_depth' = 6,
                                   'eta' = 0.05,
                                   'gamma' = 0,
                                   'colsample_bytree' = 1,
                                   'min_child_weight' = 0,
                                   'subsample' = 0.5)

boostOutRandom_GoogSRdummy = train(x = Xtrain_googSRdummy, 
                                   y = Ytrain_googSRdummy_,
                              method = 'xgbTree', verbose = 0,
                              tuneGrid = tuneGridRandom_GoogSRdummy,
                              trControl = trControl)
plot(boostOutRandom_GoogSRdummy)

boostOutRandom_GoogSRdummy$bestTune

###Overview

plot(boostOutRandom_TslaHL, main = "Boosting: TSLA diffHighLow")
plot(boostOutRandom_TslaSR, main = "Boosting: TSLA stockReturn")
plot(boostOutRandom_TslaSRdummy, main = "Boosting: TSLA stockReturn(Dummy)")

plot(boostOutRandom_GoogHL, main = "Boosting: GOOG diffHighLow")
plot(boostOutRandom_GoogSR, main = "Boosting: GOOG stockReturn")
plot(boostOutRandom_GoogSRdummy, main = "Boosting: GOOG stockReturn(Dummy)")


#List of Tuning Parameters
tuneParaBoost = rbind(
  boostOutRandom_TslaHL$bestTune,
  boostOutRandom_TslaSR$bestTune,
  boostOutRandom_TslaSRdummy$bestTune,
  boostOutRandom_GoogHL$bestTune,
  boostOutRandom_GoogSR$bestTune,
  boostOutRandom_GoogSRdummy$bestTune
  )


row.names(tuneParaBoost) = c("TSLA - diffHighLow", "TSLA - stockReturn", 
                            "TSLA - stockReturn(Dummy)","GOOG - diffHighLow", 
                            "GOOG - stockReturn","GOOG - stockReturn(Dummy)")

knitr::kable(
 tuneParaBoost,
 col.names = c("nrounds","max_depth","eta","gamma","colsample_bytree",
               "min_child_weight","subsample"),
 caption   = "Table 5: Boosting regression and Classification - Tuning Parameters",
 align     = "lccrr"
)

```

#####Performance Review

```{r importanceBoosting}
####TSLA
(boostImportance_TslaHL = xgboost::xgb.importance(model = boostOutRandom_TslaHL$finalModel))

(boostImportance_TslaSR = xgboost::xgb.importance(model = boostOutRandom_TslaSR$finalModel))

(boostImportance_TslaSRdummy = xgboost::xgb.importance(model = boostOutRandom_TslaSRdummy$finalModel))

####GOOG
(boostImportance_GoogHL = xgboost::xgb.importance(model = boostOutRandom_GoogHL$finalModel))

(boostImportance_GoogSR = xgboost::xgb.importance(model = boostOutRandom_GoogSR$finalModel))

(boostImportance_GoogSRdummy = xgboost::xgb.importance(model = boostOutRandom_GoogSRdummy$finalModel))
```

```{r judgePerformance}
set.seed(2020)
################Regression
####TSLA
#Y1
resultsTest_TslaHL  = data.frame(
  YhatGlmnet = c(predict(glmnetOutTslaHL, XtestMat_tslaHL,
                         s = elasticOutTslaHL$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutTslaHL, XtestMat_tslaHL)),
  YhatTrees  = predict(rpartOut_TslaHL, XtestMat_tslaHL),
  YhatRF     = predict(rfOut_tslaHL, XtestMat_tslaHL),
  YhatBoost  = predict(boostOutRandom_TslaHL, XtestMat_tslaHL)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_TslaHL), 
     sapply(resultsTest_TslaHL, function(Yhat){mean((Yhat - Ytest_tslaHL)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'TSLA - Supervisor = difference between highest and lowest prices')
axis(1, labels = names(resultsTest_TslaHL), at = 1:ncol(resultsTest_TslaHL), las = 3)

#Y2
resultsTest_TslaSR  = data.frame(
  YhatGlmnet = c(predict(glmnetOutTslaSR, XtestMat_tslaSR,
                         s = elasticOutTslaSR$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutTslaSR, XtestMat_tslaSR)),
  YhatTrees  = predict(rpartOut_TslaSR, XtestMat_tslaSR),
  YhatRF     = predict(rfOut_tslaSR, XtestMat_tslaSR),
  YhatBoost  = predict(boostOutRandom_TslaSR, XtestMat_tslaSR)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_TslaSR), 
     sapply(resultsTest_TslaSR, function(Yhat){mean((Yhat - Ytest_tslaSR)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'TSLA - Supervisor = stock return')
axis(1, labels = names(resultsTest_TslaSR), at = 1:ncol(resultsTest_TslaSR), las = 3)

####GOOG
#Y1
resultsTest_GoogHL  = data.frame(
  YhatGlmnet = c(predict(glmnetOutGoogHL, XtestMat_googHL,
                         s = elasticOutGoogHL$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutGoogHL, XtestMat_googHL)),
  YhatTrees  = predict(rpartOut_GoogHL, XtestMat_googHL),
  YhatRF     = predict(rfOut_googHL, XtestMat_googHL),
  YhatBoost  = predict(boostOutRandom_GoogHL, XtestMat_googHL)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_GoogHL), 
     sapply(resultsTest_GoogHL, function(Yhat){mean((Yhat - Ytest_googHL)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'GOOG - Supervisor = difference between highest and lowest prices')
axis(1, labels = names(resultsTest_GoogHL), at = 1:ncol(resultsTest_GoogHL), las = 3)

#Y2
resultsTest_GoogSR  = data.frame(
  YhatGlmnet = c(predict(glmnetOutGoogSR, XtestMat_googSR,
                         s = elasticOutGoogSR$bestTune$lambda)),
  YhatMARS   = c(predict(marsOutGoogSR, XtestMat_googSR)),
  YhatTrees  = predict(rpartOut_GoogSR, XtestMat_googSR),
  YhatRF     = predict(rfOut_googSR, XtestMat_googSR),
  YhatBoost  = predict(boostOutRandom_GoogSR, XtestMat_googSR)
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTest_GoogSR), 
     sapply(resultsTest_GoogSR, function(Yhat){mean((Yhat - Ytest_googSR)^2)}),
     xlab = '', xaxt = 'n', pch = 16, ylab = 'test error', 
     main = 'GOOG - Supervisor = stock return')
axis(1, labels = names(resultsTest_GoogSR), at = 1:ncol(resultsTest_GoogSR), las = 3)










###################Classification
####TSLA
#TSLA MARS(FDA)- Y3
YhatTestFDA_TslaSRdummyProb = predict(marsOutTslaSRdummy, Xtest_tslaSRdummy,
                                  type = 'prob')
YhatTestFDA_TslaSRdummy     = ifelse(YhatTestFDA_TslaSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestFDA_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyFDA = sum(diag(table(YhatTestFDA_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#TSLA Classification Tree - Y3
YhatTestTree_TslaSRdummyProb = predict(rpartOut_TslaSRdummy, Xtest_tslaSRdummy,
                                  type = 'prob')
YhatTestTree_TslaSRdummy     = ifelse(YhatTestTree_TslaSRdummyProb[,2] > 0.5, '1','0')
table(YhatTestTree_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyTree = sum(diag(table(YhatTestTree_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#TSLA Random Forest - Y3
YhatTestRF_TslaSRdummyProb = predict(rfOut_tslaSRdummy, Xtest_tslaSRdummy,
                                  type = 'prob')

YhatTestRF_TslaSRdummy     = ifelse(YhatTestRF_TslaSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestRF_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyRF = sum(diag(table(YhatTestRF_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#TSLA Boosting - Y3
YhatTestBoost_TslaSRdummyProb = predict(boostOutRandom_TslaSRdummy,
                                        XtestMat_tslaSRdummy,type = 'prob')
YhatTestBoost_TslaSRdummy     = ifelse(YhatTestBoost_TslaSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestBoost_TslaSRdummy, Ytest_tslaSRdummy)
(TslaSRdummy_accuracyBoost = sum(diag(table(YhatTestBoost_TslaSRdummy, Ytest_tslaSRdummy)))/length(Ytest_tslaSRdummy))

#Summary - TSLA - Classification
resultsTestClass_Tsla = data.frame(
  accuracyFDA  = TslaSRdummy_accuracyFDA,
  accuracyTree = TslaSRdummy_accuracyTree,
  accuracyRF = TslaSRdummy_accuracyRF,
  accuracyBoost = TslaSRdummy_accuracyBoost
)
par(mar=c(7,5,4,2))
plot(1:length(resultsTestClass_Tsla), 
     resultsTestClass_Tsla,
     xlab = '', xaxt = 'n', pch = 16, ylab = 'accuracy', 
     main = 'TSLA - Supervisor = stock return (dummy)')
axis(1, labels = names(resultsTestClass_Tsla), at = 1:ncol(resultsTestClass_Tsla), las = 3)


####GOOG
#GOOG MARS(FDA) - Y3
YhatTestFDA_GoogSRdummyProb = predict(marsOutGoogSRdummy, Xtest_googSRdummy,
                                  type = 'prob')

YhatTestFDA_GoogSRdummy     = ifelse(YhatTestFDA_GoogSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestFDA_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyFDA = sum(diag(table(YhatTestFDA_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))

#GOOG Classification Tree - Y3
YhatTestTree_GoogSRdummyProb = predict(rpartOut_GoogSRdummy, Xtest_googSRdummy,
                                  type = 'prob')
YhatTestTree_GoogSRdummy     = ifelse(YhatTestTree_GoogSRdummyProb[,2] > 0.5, '1','0')
table(YhatTestTree_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyTree = sum(diag(table(YhatTestTree_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))

#GOOG Random Forest - Y3
YhatTestRF_GoogSRdummyProb = predict(rfOut_googSRdummy, Xtest_googSRdummy,
                                  type = 'prob')

YhatTestRF_GoogSRdummy     = ifelse(YhatTestRF_GoogSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestRF_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyRF = sum(diag(table(YhatTestRF_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))


#GOOG Boosting - Y3
YhatTestBoost_GoogSRdummyProb = predict(boostOutRandom_GoogSRdummy,
                                        XtestMat_googSRdummy,type = 'prob')
YhatTestBoost_GoogSRdummy     = ifelse(YhatTestBoost_GoogSRdummyProb[,2] > 0.5, '1','0')

table(YhatTestBoost_GoogSRdummy, Ytest_googSRdummy)
(GoogSRdummy_accuracyBoost = sum(diag(table(YhatTestBoost_GoogSRdummy, Ytest_googSRdummy)))/length(Ytest_googSRdummy))


#Summary - GOOG - Classification
resultsTestClass_Goog = data.frame(
  accuracyFDA   = GoogSRdummy_accuracyFDA,
  accuracyTree  = GoogSRdummy_accuracyTree,
  accuracyRF    = GoogSRdummy_accuracyRF,
  accuracyBoost = GoogSRdummy_accuracyBoost
)

par(mar=c(7,5,4,2))
plot(1:length(resultsTestClass_Goog), 
     resultsTestClass_Goog,
     xlab = '', xaxt = 'n', pch = 16,  ylab = 'accuracy', 
     main = 'GOOG - Supervisor = stock return (dummy)')
axis(1, labels = names(resultsTestClass_Goog), at = 1:ncol(resultsTestClass_Goog), las = 3)




```














